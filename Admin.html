<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="Shortcut Icon" type="image/png" href="stmikelogorig.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>St. Michael's Clinic Diagnostic Center â€” Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* ===== BASE STYLES ===== */
        :root {
            --gold-1: #ffd66b;
            --gold-2: #ffb84d;
            --gold-3: #ff9d1a;
            --muted: #6b7280;
            --card-bg: #ffffff;
            --text-dark: #07121a;
            --panel-radius: 14px;
            --background: #f8fafc;
            --error: #dc2626;
            --success: #16a34a;
            --warning: #d97706;
            --border: rgba(2, 6, 23, 0.08);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            height: 100%;
            font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
            background: url('clinicbgg.png') center/cover no-repeat fixed;
            min-height: 100vh;
            color: var(--text-dark);
            overflow-x: hidden;
        }

        button {
            cursor: pointer;
        }

        input,
        select {
            outline: none;
        }

        /* ===== ADMIN DASHBOARD STYLES ===== */
        #adminDashboard {
            display: block;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
            color: var(--text-dark);
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.00)), url('clinicbgg.png') center/cover no-repeat fixed;
        }

        .app-wrap {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 20px;
            align-items: flex-start;
            min-height: calc(100vh - 40px);
        }

        .sidebar {
            width: 260px;
            flex: 0 0 260px;
            background: var(--card-bg);
            border-radius: var(--panel-radius);
            padding: 20px;
            box-shadow: 0 10px 40px rgba(2, 6, 23, 0.06);
            border: 1px solid rgba(2, 6, 23, 0.04);
            display: flex;
            flex-direction: column;
            gap: 15px;
            height: calc(100vh - 40px);
            position: sticky;
            top: 20px;
            overflow-y: auto;
        }

        .logo-mini {
            width: 56px;
            height: 56px;
            border-radius: 10px;
            background-image: url('stmike.png');
            background-size: cover;
            background-position: center;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
        }

        .brand {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .brand h3 {
            margin: 0;
            font-size: 1rem;
            color: var(--text-dark);
        }

        .brand p {
            margin: 0;
            font-size: 12px;
            color: var(--muted);
        }

        .nav-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .nav-btn {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 12px 15px;
            border-radius: 10px;
            background: transparent;
            color: var(--text-dark);
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all .18s ease;
        }

        .nav-btn .icon {
            width: 34px;
            height: 34px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(180deg, rgba(255, 235, 190, 0.6), rgba(255, 200, 110, 0.25));
            color: var(--gold-3);
        }

        .nav-btn:hover {
            transform: translateX(6px);
            background: rgba(255, 210, 120, 0.06);
        }

        .nav-btn.active {
            background: rgba(255, 220, 120, 0.12);
            box-shadow: 0 8px 26px rgba(255, 190, 80, 0.06);
        }

        .spacer {
            flex: 1;
        }

        .main {
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-height: calc(100vh - 40px);
            overflow-y: auto;
            max-height: calc(100vh - 40px);
            width: calc(100vw - 320px);
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            background: var(--card-bg);
            border-radius: var(--panel-radius);
            padding: 20px;
            box-shadow: 0 10px 30px rgba(2, 6, 23, 0.06);
            border: 1px solid rgba(2, 6, 23, 0.04);
            width: 100%;
        }

        h1 {
            font-size: 1.4rem;
            margin: 0;
            color: var(--text-dark);
        }

        .sub-muted {
            color: var(--muted);
            font-size: 14px;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            width: 100%;
        }

        .card-small {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(2, 6, 23, 0.04);
            box-shadow: 0 10px 30px rgba(2, 6, 23, 0.06);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .title {
            font-size: 14px;
            color: var(--muted);
            margin: 0;
        }

        .value {
            font-size: 24px;
            font-weight: 800;
            color: var(--text-dark);
        }

        .panel {
            background: var(--card-bg);
            border-radius: var(--panel-radius);
            padding: 20px;
            border: 1px solid rgba(2, 6, 23, 0.04);
            box-shadow: 0 12px 34px rgba(2, 6, 23, 0.06);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 400px;
            max-height: 80vh;
            width: 100%;
        }

        .panel-content {
            overflow-y: auto;
            flex: 1;
            min-height: 200px;
            width: 100%;
        }

        .form-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        input,
        select {
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid rgba(2, 6, 23, 0.1);
            background: #fff;
            color: var(--text-dark);
            min-width: 140px;
            transition: all 0.3s ease;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--gold-2);
            box-shadow: 0 0 0 3px rgba(255, 180, 60, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            color: var(--text-dark);
        }

        th,
        td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(2, 6, 23, 0.04);
            text-align: left;
            font-size: 14px;
        }

        th {
            font-weight: 700;
            background: rgba(255, 210, 120, 0.05);
        }

        .btn-primary {
            background: linear-gradient(90deg, var(--gold-1), var(--gold-2));
            color: #111;
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 180, 60, 0.3);
        }

        .btn-danger {
            background: linear-gradient(90deg, #ff6b6b, #ff3b3b);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 59, 59, 0.3);
        }

        .btn-warning {
            background: linear-gradient(90deg, #f59e0b, #d97706);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(217, 119, 6, 0.3);
        }

        .btn-refresh {
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-refresh:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(29, 78, 216, 0.3);
        }

        .btn-edit {
            background: linear-gradient(90deg, #10b981, #059669);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-edit:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }

        .btn-success {
            background: linear-gradient(90deg, #10b981, #059669);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }

        .status-badge {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .status-critical {
            background: #fee2e2;
            color: #dc2626;
            border-left: 3px solid #dc2626;
        }

        .status-low {
            background: #ffedd5;
            color: #ea580c;
            border-left: 3px solid #ea580c;
        }

        .status-moderate {
            background: #fef3c7;
            color: #d97706;
            border-left: 3px solid #d97706;
        }

        .status-well {
            background: #d1fae5;
            color: #065f46;
            border-left: 3px solid #10b981;
        }

        .status-excellent {
            background: #dbeafe;
            color: #1e40af;
            border-left: 3px solid #3b82f6;
        }

        .status-pending {
            background: #fef3c7;
            color: #d97706;
            border-left: 3px solid #d97706;
        }

        .status-approved {
            background: #d1fae5;
            color: #065f46;
            border-left: 3px solid #10b981;
        }

        .status-denied {
            background: #fee2e2;
            color: #dc2626;
            border-left: 3px solid #dc2626;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid rgba(2, 6, 23, 0.08);
            width: 100%;
        }

        table {
            min-width: 600px;
        }

        tr:hover {
            background-color: rgba(255, 210, 120, 0.05);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--muted);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin: 0 0 10px 0;
            font-size: 18px;
            color: var(--text-dark);
        }

        .empty-state p {
            margin: 0;
            font-size: 14px;
        }

        .date-status-container {
            background: var(--card-bg);
            border-radius: var(--panel-radius);
            padding: 20px;
            box-shadow: 0 10px 30px rgba(2, 6, 23, 0.06);
            border: 1px solid rgba(2, 6, 23, 0.04);
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 220px;
        }

        .date-display {
            font-size: 14px;
            color: var(--muted);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .date-display strong {
            color: var(--text-dark);
            font-weight: 600;
        }

        .status-display {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #16a34a;
            animation: pulse 2s infinite;
        }

        .time-display {
            font-size: 14px;
            color: var(--muted);
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        .time-display strong {
            color: var(--text-dark);
            font-weight: 600;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid rgba(2, 6, 23, 0.1);
            background: #fff;
            color: var(--text-dark);
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--gold-2);
            box-shadow: 0 0 0 3px rgba(255, 180, 60, 0.1);
        }

        /* Toast */
        .toast {
            position: fixed;
            right: 20px;
            bottom: 20px;
            background: #fff;
            color: var(--text-dark);
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(2, 6, 23, 0.15);
            opacity: 0;
            transform: translateY(10px);
            transition: all .32s ease;
            z-index: 99998;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 350px;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--error);
        }

        .toast.warning {
            border-left: 4px solid var(--warning);
        }

        /* Report Styles */
        .report-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .report-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: var(--card-bg);
            border-radius: var(--panel-radius);
            padding: 15px;
            border: 1px solid rgba(2, 6, 23, 0.04);
            box-shadow: 0 4px 12px rgba(2, 6, 23, 0.06);
            text-align: center;
        }

        .summary-card h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: var(--muted);
        }

        .summary-card .amount {
            font-size: 24px;
            font-weight: 800;
            color: var(--success);
        }

        /* Print Styles */
        @media print {
            body * {
                visibility: hidden;
            }

            #printSection,
            #printSection * {
                visibility: visible;
            }

            #printSection {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white;
                padding: 20px;
            }

            /* Improve print quality */
            table {
                page-break-inside: auto;
            }

            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }

            thead {
                display: table-header-group;
            }

            tfoot {
                display: table-footer-group;
            }
        }

        .print-section {
            display: none;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99999;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--text-dark);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--muted);
        }

        /* Preview Modal */
        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99999;
            align-items: center;
            justify-content: center;
        }

        .preview-content {
            background: white;
            border-radius: 12px;
            padding: 25px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        /* Confirmation Modal Styles */
        .confirmation-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99999;
            align-items: center;
            justify-content: center;
        }

        .confirmation-content {
            background: white;
            border-radius: 12px;
            padding: 25px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .confirmation-text {
            margin-bottom: 20px;
            font-size: 16px;
            color: var(--text-dark);
        }

        .confirmation-timer {
            font-size: 14px;
            color: var(--muted);
            margin-bottom: 20px;
        }

        .confirmation-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        /* Edit Utilities Modal */
        .edit-utilities-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99999;
            align-items: center;
            justify-content: center;
        }

        .edit-utilities-content {
            background: white;
            border-radius: 12px;
            padding: 25px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        /* EDIT UTENSILS MODAL */
        .edit-utensils-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99999;
            align-items: center;
            justify-content: center;
        }

        .edit-utensils-content {
            background: white;
            border-radius: 12px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        /* History Panel Styles */
        .history-panel {
            background: var(--card-bg);
            border-radius: var(--panel-radius);
            padding: 20px;
            border: 1px solid rgba(2, 6, 23, 0.04);
            box-shadow: 0 12px 34px rgba(2, 6, 23, 0.06);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 500px;
            max-height: 80vh;
        }

        .history-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .history-table-container {
            overflow-x: auto;
            margin-top: 15px;
            max-height: 500px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid rgba(2, 6, 23, 0.08);
        }

        /* FIXED: Adjusted table column widths for Walk-In section */
        #walkinTable th:nth-child(5),
        #walkinTable td:nth-child(5) {
            max-width: 120px;
            min-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        #walkinTable th:nth-child(6),
        #walkinTable td:nth-child(6) {
            max-width: 150px;
            min-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        #walkinTable th:nth-child(7),
        #walkinTable td:nth-child(7) {
            max-width: 150px;
            min-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Chart container */
        .chart-container {
            position: relative;
            height: 320px;
            width: 100%;
        }

        /* IMPROVED: Summary cards layout */
        .summary-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card-compact {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(2, 6, 23, 0.04);
            box-shadow: 0 4px 12px rgba(2, 6, 23, 0.06);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 90px;
        }

        .summary-card-compact .title {
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 5px;
        }

        .summary-card-compact .value {
            font-size: 20px;
            font-weight: 800;
            color: var(--text-dark);
        }

        .summary-card-compact .amount {
            font-size: 20px;
            font-weight: 800;
            color: var(--success);
        }

        /* NEW: Compact form controls */
        .compact-form {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .compact-form input,
        .compact-form select {
            padding: 10px 12px;
            min-width: 120px;
            font-size: 14px;
        }

        .compact-form button {
            padding: 10px 12px;
            font-size: 14px;
        }

        /* NEW: Panel header with better layout */
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .panel-header h3 {
            margin: 0;
            font-size: 1.2rem;
        }

        /* NEW: AI Voice Notification Panel */
        .ai-notification-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 420px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            transform: translateX(450px);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            overflow: hidden;
        }

        .ai-notification-panel.show {
            transform: translateX(0);
        }

        .ai-notification-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .ai-notification-header i {
            font-size: 20px;
            color: white;
            animation: pulse 2s infinite;
        }

        .ai-notification-title {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
        }

        .ai-notification-content {
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 10px;
        }

        .ai-notification-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .ai-voice-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .ai-voice-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .close-ai-notification {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 18px;
            position: absolute;
            top: 10px;
            right: 10px;
        }

        /* Inventory Status Badges - CLICKABLE VERSION */
        .inventory-status {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .inventory-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        /* CLICKABLE INVENTORY ITEM STYLES */
        .inventory-item.clickable {
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .inventory-item.clickable:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .inventory-item.clickable:active {
            transform: translateX(2px);
        }

        /* Navigation indicator for clickable items */
        .clickable-indicator {
            margin-left: auto;
            font-size: 12px;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .inventory-item.clickable:hover .clickable-indicator {
            opacity: 1;
        }

        .inventory-item-name {
            font-size: 13px;
            font-weight: 500;
            flex: 1;
        }

        .inventory-item-status {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
            margin-left: 8px;
            white-space: nowrap;
        }

        .status-critical-badge {
            background: #dc2626;
            color: white;
        }

        .status-low-badge {
            background: #f59e0b;
            color: white;
        }

        .status-good-badge {
            background: #16a34a;
            color: white;
        }

        /* Action buttons on hover */
        .inventory-item-actions {
            display: flex;
            gap: 4px;
            margin-left: 8px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .inventory-item.clickable:hover .inventory-item-actions {
            opacity: 1;
        }

        .inventory-action-btn {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.15);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            transition: all 0.3s;
        }

        .inventory-action-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.1);
        }

        /* Voice controls */
        .voice-controls {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 8px;
        }

        .voice-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
        }

        .voice-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }

        .voice-btn.playing {
            animation: pulse 1s infinite;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        /* Hourly Reminder Indicator */
        .hourly-reminder-indicator {
            position: absolute;
            top: 8px;
            right: 40px;
            width: 8px;
            height: 8px;
            background: #f59e0b;
            border-radius: 50%;
            animation: blink 2s infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        @media (max-width: 1200px) {
            .app-wrap {
                flex-direction: column;
                padding: 10px;
            }

            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                top: auto;
            }

            .nav-list {
                flex-direction: row;
                gap: 6px;
                overflow: auto;
            }

            .nav-btn {
                white-space: nowrap;
                padding: 10px 12px;
            }

            .date-status-container {
                min-width: auto;
                width: 100%;
            }

            .header-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .form-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .form-row>* {
                width: 100%;
            }

            .panel {
                min-height: 300px;
                max-height: 60vh;
            }

            .summary-cards-container {
                grid-template-columns: repeat(2, 1fr);
            }

            .main {
                width: 100%;
            }

            .ai-notification-panel {
                top: 10px;
                right: 10px;
                left: 10px;
                width: auto;
                max-width: calc(100% - 20px);
            }

            .voice-controls {
                bottom: 70px;
                right: 10px;
            }
        }

        @media (max-width: 768px) {
            .cards-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .summary-cards-container {
                grid-template-columns: 1fr;
            }

            .compact-form {
                flex-direction: column;
                align-items: stretch;
            }

            .compact-form input,
            .compact-form select,
            .compact-form button {
                width: 100%;
            }

            .panel-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .ai-notification-actions {
                flex-direction: column;
            }

            .ai-voice-btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Improved sidebar scroll */
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(255, 180, 60, 0.3);
            border-radius: 10px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 180, 60, 0.5);
        }

        /* Panel scrollbar */
        .panel-content::-webkit-scrollbar {
            width: 8px;
        }

        .panel-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .panel-content::-webkit-scrollbar-thumb {
            background: rgba(255, 180, 60, 0.3);
            border-radius: 10px;
        }

        .panel-content::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 180, 60, 0.5);
        }

        /* Main scrollbar */
        .main::-webkit-scrollbar {
            width: 8px;
        }

        .main::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .main::-webkit-scrollbar-thumb {
            background: rgba(255, 180, 60, 0.3);
            border-radius: 10px;
        }

        .main::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 180, 60, 0.5);
        }

        /* Zoom controls */
        .zoom-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
            background: var(--card-bg);
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gold-1);
            border: none;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.2s;
        }

        .zoom-btn:hover {
            background: var(--gold-2);
            transform: scale(1.1);
        }

        .zoom-display {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            font-weight: 600;
            color: var(--text-dark);
        }

        /* AI Voice Animation */
        @keyframes voiceWave {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .voice-wave {
            display: inline-block;
            animation: voiceWave 1s infinite;
        }

        /* Success Celebration Animation */
        @keyframes celebrate {
            0% {
                transform: scale(0.8) rotate(-10deg);
            }

            25% {
                transform: scale(1.1) rotate(10deg);
            }

            50% {
                transform: scale(1) rotate(-5deg);
            }

            75% {
                transform: scale(1.05) rotate(5deg);
            }

            100% {
                transform: scale(1) rotate(0deg);
            }
        }

        .celebrate {
            animation: celebrate 0.5s ease;
        }

        /* Quick Edit Modal - IMPROVED */
        .quick-edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99999;
            align-items: center;
            justify-content: center;
        }

        .quick-edit-content {
            background: white;
            border-radius: 12px;
            padding: 25px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        .quick-edit-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .quick-edit-header i {
            font-size: 24px;
            color: #dc2626;
        }

        .quick-edit-header h3 {
            margin: 0;
            color: var(--text-dark);
            font-size: 1.3rem;
        }

        .quick-edit-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            background: #fef2f2;
            color: #dc2626;
            font-weight: 600;
        }

        .quick-edit-status i {
            font-size: 16px;
        }

        .inventory-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .detail-card {
            background: #f8fafc;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #3b82f6;
        }

        .detail-card.gold {
            border-left: 4px solid var(--gold-3);
        }

        .detail-card.red {
            border-left: 4px solid #dc2626;
        }

        .detail-card.green {
            border-left: 4px solid #16a34a;
        }

        .detail-label {
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-dark);
        }

        .restock-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .restock-option-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .restock-option-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }

        .restock-option-card.active {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .restock-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            color: white;
        }

        .restock-icon.add {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .restock-icon.edit {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }

        .restock-option-info {
            flex: 1;
        }

        .restock-option-title {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 5px;
        }

        .restock-option-desc {
            font-size: 13px;
            color: var(--muted);
        }

        .restock-amount-input {
            margin: 20px 0;
            padding: 20px;
            background: #f8fafc;
            border-radius: 10px;
            display: none;
        }

        .restock-amount-input.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .amount-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .amount-btn {
            padding: 8px 15px;
            border-radius: 6px;
            background: white;
            border: 1px solid #d1d5db;
            color: var(--text-dark);
            cursor: pointer;
            transition: all 0.2s;
        }

        .amount-btn:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }

        .amount-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .quick-edit-btn {
            min-width: 120px;
        }
    </style>
</head>

<body>

    <!-- ADMIN DASHBOARD -->
    <div id="adminDashboard">
        <div class="app-wrap">
            <aside class="sidebar">
                <div style="display:flex;gap:12px;align-items:center;">
                    <div class="logo-mini"></div>
                    <div class="brand">
                        <h3>St. Michael's</h3>
                        <p>Medical
                            Center</p>
                    </div>
                </div>

                <div class="nav-list" id="navList">
                    <button class="nav-btn active" data-target="overview">
                        <div class="icon"><i class="fas fa-chart-line"></i></div>
                        <div>Overview</div>
                    </button>
                    <button class="nav-btn" data-target="utensils">
                        <div class="icon"><i class="fas fa-utensils"></i></div>
                        <div>Utensils
                            Inventory</div>
                    </button>
                    <button class="nav-btn" data-target="supplies">
                        <div class="icon"><i class="fas fa-boxes"></i></div>
                        <div>Medical
                            Supplies</div>
                    </button>
                    <button class="nav-btn" data-target="appointments">
                        <div class="icon"><i class="fas fa-calendar-alt"></i></div>
                        <div>Appointments</div>
                    </button>
                    <button class="nav-btn" data-target="administrators">
                        <div class="icon"><i class="fas fa-user-shield"></i></div>
                        <div>Administrators</div>
                    </button>
                    <button class="nav-btn" data-target="sales">
                        <div class="icon"><i class="fas fa-money-bill-wave"></i></div>
                        <div>Sales</div>
                    </button>
                    <button class="nav-btn" data-target="walkin">
                        <div class="icon"><i class="fas fa-walking"></i></div>
                        <div>Walk-In</div>
                    </button>
                    <button class="nav-btn" data-target="company">
                        <div class="icon"><i class="fas fa-building"></i></div>
                        <div>Company</div>
                    </button>
                    <button class="nav-btn" data-target="reports">
                        <div class="icon"><i class="fas fa-file-alt"></i></div>
                        <div>Reports</div>
                    </button>
                    <button class="nav-btn" data-target="history">
                        <div class="icon"><i class="fas fa-history"></i></div>
                        <div>History</div>
                    </button>
                </div>

                <div class="spacer"></div>

                <!-- SIGNED IN AS ADMIN AND LOGOUT BUTTON -->
                <div style="font-size:14px;color:var(--muted);display:flex;flex-direction:column;gap:10px">
                    <div id="signedInAs">Signed in as <strong style="color:var(--gold-3)"
                            id="currentUserName">Loading...</strong></div>
                    <button id="logoutBtn" class="btn-danger" style="width:120px;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </aside>

            <main class="main">
                <div class="header-row">
                    <div>
                        <h1 id="welcomeMessage">Welcome to St. Michael's
                            Clinic Admin Portal, Admin!</h1>
                        <div class="sub-muted" style="color: rgb(0, 0, 0);">Manage utensils,
                            monitor supplies, oversee appointments, and
                            track sales.</div>
                    </div>

                    <div class="date-status-container">
                        <div class="date-display">
                            <i class="fas fa-calendar"></i>
                            Today: <strong id="todayDate"></strong>
                        </div>
                        <div class="status-display">
                            <span class="status-dot"></span>
                            System Status: <span style="color:#16a34a;">Operational</span>
                        </div>
                        <div class="time-display">
                            <i class="fas fa-clock"></i>
                            Time: <strong id="realTime"></strong>
                        </div>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card-small">
                        <p class="title">Total Utensils</p>
                        <div class="value" id="statUtensils">0</div>
                    </div>
                    <div class="card-small">
                        <p class="title">Pending Appointments</p>
                        <div class="value" id="statPendingAppt">0</div>
                    </div>
                    <div class="card-small">
                        <p class="title">Administrators</p>
                        <div class="value" id="statAdmins">0</div>
                    </div>
                    <div class="card-small">
                        <p class="title">Sales (Today)</p>
                        <div class="value" id="statSalesDay">â‚±0.00</div>
                    </div>
                </div>

                <section id="overview" class="panel">
                    <div class="panel-content">
                        <div class="panel-header">
                            <h3>Sales â€” Daily (Last 7 days)</h3>
                            <button class="btn-refresh" id="refreshOverview"><i class="fas fa-sync-alt"></i>
                                Refresh</button>
                        </div>
                        <div class="chart-container">
                            <canvas id="salesChart"></canvas>
                        </div>
                    </div>
                </section>

                <!-- UTENSILS INVENTORY SECTION - UPDATED WITH EDIT FUNCTIONALITY -->
                <section id="utensils" class="panel" style="display:none">
                    <div class="panel-content">
                        <div class="panel-header">
                            <h3>Utensils Inventory</h3>
                            <div class="compact-form">
                                <input id="utensil_name" placeholder="Utensil name" type="text" />
                                <input id="utensil_qty" placeholder="Qty" type="number" min="1" style="width:80px" />
                                <button class="btn-primary" id="addUtensil"><i class="fas fa-plus"></i>
                                    Add</button>
                                <button class="btn-refresh" id="refreshUtensils"><i class="fas fa-sync-alt"></i>
                                    Refresh</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table id="utensilTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Qty</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="utensilTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- MEDICAL SUPPLIES SECTION -->
                <section id="supplies" class="panel" style="display:none">
                    <div class="panel-content">
                        <div class="panel-header">
                            <h3>Medical Supplies</h3>
                            <div class="compact-form">
                                <input id="supply_name" placeholder="Item name" type="text" />
                                <input id="supply_qty" placeholder="Qty" type="number" min="0" style="width:80px" />
                                <button class="btn-primary" id="addSupply"><i class="fas fa-plus"></i> Add /
                                    Update</button>
                                <button class="btn-refresh" id="refreshSupplies"><i class="fas fa-sync-alt"></i>
                                    Refresh</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table id="supplyTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Qty</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="supplyTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- APPOINTMENTS SECTION -->
                <section id="appointments" class="panel" style="display:none">
                    <div class="panel-content">
                        <div class="panel-header">
                            <h3>Appointments (Admin)</h3>
                            <div class="compact-form">
                                <input id="appt_patient" placeholder="Patient name" type="text" />
                                <input id="appt_date" placeholder="Date" type="date" />
                                <button class="btn-primary" id="addAppt"><i class="fas fa-plus"></i>
                                    Add</button>
                                <button class="btn-refresh" id="refreshAppointments"><i class="fas fa-sync-alt"></i>
                                    Refresh</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table id="apptTable">
                                <thead>
                                    <tr>
                                        <th>No.</th>
                                        <th>Patient</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="apptTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- ADMINISTRATORS SECTION -->
                <section id="administrators" class="panel" style="display:none">
                    <div class="panel-content">
                        <div class="panel-header">
                            <h3>Administrators List</h3>
                            <div class="compact-form">
                                <button class="btn-primary" id="addAdminBtn"><i class="fas fa-plus"></i> Add
                                    Admin</button>
                                <button class="btn-refresh" id="refreshAdministrators"><i class="fas fa-sync-alt"></i>
                                    Refresh</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table id="adminTable">
                                <thead>
                                    <tr>
                                        <th>No.</th>
                                        <th>First Name</th>
                                        <th>Last Name</th>
                                        <th>Phone</th>
                                        <th>Username</th>
                                        <th>Date Added</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="adminTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- SALES SECTION - IMPROVED LAYOUT -->
                <section id="sales" class="panel" style="display:none">
                    <div class="panel-content">
                        <div class="panel-header">
                            <h3>Sales & Transactions</h3>
                            <div class="compact-form">
                                <input id="sale_note" placeholder="Service" type="text" />
                                <input id="sale_amount" placeholder="Amount" type="number" min="0" step="0.01"
                                    oninput="validateAmount(this)" />
                                <button class="btn-primary" id="recordSale"><i class="fas fa-plus"></i>
                                    Record</button>
                                <button class="btn-refresh" id="refreshSales"><i class="fas fa-sync-alt"></i>
                                    Refresh</button>
                            </div>
                        </div>

                        <!-- IMPROVED: Compact summary cards -->
                        <div class="summary-cards-container">
                            <div class="summary-card-compact">
                                <div class="title">Today's Total</div>
                                <div class="amount" id="dailyTotal">â‚±0.00</div>
                            </div>
                            <div class="summary-card-compact">
                                <div class="title">This Month</div>
                                <div class="amount" id="monthlyTotal">â‚±0.00</div>
                            </div>
                        </div>

                        <div class="table-container">
                            <table id="salesTable">
                                <thead>
                                    <tr>
                                        <th>No.</th>
                                        <th>Service</th>
                                        <th>Amount</th>
                                        <th>Date</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="salesTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- WALK-IN SECTION - IMPROVED LAYOUT -->
                <section id="walkin" class="panel" style="display:none">
                    <div class="panel-content">
                        <div class="panel-header">
                            <h3>Walk-In Appointments</h3>
                            <div class="compact-form">
                                <button class="btn-success" id="saveWalkinHistory"><i class="fas fa-save"></i> Save in
                                    History</button>
                                <button class="btn-success" id="printWalkinReport"><i class="fas fa-print"></i> Print
                                    Report</button>
                                <button class="btn-refresh" id="refreshWalkins"><i class="fas fa-sync-alt"></i>
                                    Refresh</button>
                            </div>
                        </div>

                        <!-- IMPROVED: Compact summary cards -->
                        <div class="summary-cards-container">
                            <div class="summary-card-compact">
                                <div class="title">Total Amount</div>
                                <div class="amount" id="walkinTotalAmount">â‚±0.00</div>
                            </div>
                            <div class="summary-card-compact">
                                <div class="title">Total Appointments</div>
                                <div class="value" id="walkinTotalAppt">0</div>
                            </div>
                        </div>

                        <div class="table-container">
                            <table id="walkinTable">
                                <thead>
                                    <tr>
                                        <th>No.</th>
                                        <th>Patient</th>
                                        <th>Procedures</th>
                                        <th>Amount</th>
                                        <th>Date</th>
                                        <th>Contact</th>
                                        <th>Doctor</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="walkinTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- COMPANY SECTION - IMPROVED LAYOUT -->
                <section id="company" class="panel" style="display:none">
                    <div class="panel-content">
                        <div class="panel-header">
                            <h3>Company Appointments</h3>
                            <div class="compact-form">
                                <button class="btn-success" id="saveCompanyHistory"><i class="fas fa-save"></i> Save in
                                    History</button>
                                <button class="btn-refresh" id="refreshCompanies"><i class="fas fa-sync-alt"></i>
                                    Refresh</button>
                            </div>
                        </div>

                        <!-- IMPROVED: Compact summary cards -->
                        <div class="summary-cards-container">
                            <div class="summary-card-compact">
                                <div class="title">Total Amount</div>
                                <div class="amount" id="companyTotalAmount">â‚±0.00</div>
                            </div>
                            <div class="summary-card-compact">
                                <div class="title">Total Appointments</div>
                                <div class="value" id="companyTotalAppt">0</div>
                            </div>
                        </div>

                        <div class="table-container">
                            <table id="companyTable">
                                <thead>
                                    <tr>
                                        <th>No.</th>
                                        <th>Patient</th>
                                        <th>Company</th>
                                        <th>Package</th>
                                        <th>Amount</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="companyTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- REPORTS SECTION -->
                <section id="reports" class="panel" style="display:none">
                    <div class="panel-content">
                        <div class="panel-header">
                            <h3>Financial Reports & History</h3>
                            <div class="compact-form">
                                <button class="btn-success" id="printTotalReport"><i class="fas fa-file-pdf"></i> Print
                                    the Total</button>
                                <button class="btn-primary" id="previewTotalReport"><i class="fas fa-eye"></i> Preview
                                    Report</button>
                                <button class="btn-refresh" id="refreshReports"><i class="fas fa-sync-alt"></i>
                                    Refresh</button>
                            </div>
                        </div>

                        <!-- Report Summary -->
                        <div class="report-summary">
                            <div class="summary-card">
                                <h4>Total Walk-In Revenue</h4>
                                <div class="amount" id="reportWalkinTotal">â‚±0.00</div>
                            </div>
                            <div class="summary-card">
                                <h4>Total Company Revenue</h4>
                                <div class="amount" id="reportCompanyTotal">â‚±0.00</div>
                            </div>
                            <div class="summary-card">
                                <h4>Combined Total</h4>
                                <div class="amount" id="reportCombinedTotal">â‚±0.00</div>
                            </div>
                            <div class="summary-card">
                                <h4>Total Reports</h4>
                                <div class="amount" id="reportTotalCount">0</div>
                            </div>
                        </div>

                        <!-- Report History -->
                        <h4 style="margin:20px 0 10px 0">Report History</h4>
                        <div class="table-container">
                            <table id="reportsTable">
                                <thead>
                                    <tr>
                                        <th>Report ID</th>
                                        <th>Date Generated</th>
                                        <th>Walk-In Total</th>
                                        <th>Company Total</th>
                                        <th>Combined Total</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="reportsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- HISTORY SECTION -->
                <section id="history" class="history-panel" style="display:none">
                    <div class="panel-content">
                        <div class="panel-header">
                            <h3>Appointment History</h3>
                            <div class="compact-form">
                                <button class="btn-success" id="printHistoryReport"><i class="fas fa-print"></i> Print
                                    History</button>
                                <button class="btn-refresh" id="refreshHistory"><i class="fas fa-sync-alt"></i>
                                    Refresh</button>
                            </div>
                        </div>

                        <div class="history-table-container">
                            <table id="appointmentHistoryTable">
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th>No.</th>
                                        <th>Patient</th>
                                        <th>Details</th>
                                        <th>Amount</th>
                                        <th>Date</th>
                                        <th>Contact</th>
                                        <th>Doctor</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="appointmentHistoryBody"></tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- AI VOICE NOTIFICATION PANEL -->
    <div class="ai-notification-panel" id="aiNotificationPanel">
        <div class="hourly-reminder-indicator" id="hourlyReminderIndicator"></div>
        <button class="close-ai-notification" id="closeAiNotification">&times;</button>
        <div class="ai-notification-header">
            <i class="fas fa-robot"></i>
            <h3 class="ai-notification-title" id="aiNotificationTitle">Inventory Status Report</h3>
        </div>
        <div class="ai-notification-content" id="aiNotificationContent">
            <!-- Content will be populated by JavaScript -->
        </div>
        <div class="inventory-status" id="inventoryStatusList">
            <!-- Inventory items will be listed here as clickable elements -->
        </div>
        <div class="ai-notification-actions">
            <button class="ai-voice-btn" id="playVoiceReport">
                <i class="fas fa-volume-up"></i> Play Report
            </button>
            <button class="ai-voice-btn" id="snoozeNotification">
                <i class="fas fa-clock"></i> Snooze 1 Hour
            </button>
            <button class="ai-voice-btn" id="quickRestockAll">
                <i class="fas fa-bolt"></i> Quick Restock
            </button>
        </div>
    </div>

    <!-- IMPROVED QUICK EDIT MODAL -->
    <div id="quickEditModal" class="quick-edit-modal">
        <div class="quick-edit-content">
            <div class="quick-edit-header">
                <i class="fas fa-exclamation-triangle"></i>
                <h3 id="quickEditTitle">Restock Inventory Item</h3>
            </div>

            <div class="quick-edit-status" id="quickEditStatus">
                <i class="fas fa-exclamation-circle"></i>
                <span id="statusText">Critical Stock Alert</span>
            </div>

            <div class="inventory-details">
                <div class="detail-card gold">
                    <div class="detail-label">Item Name</div>
                    <div class="detail-value" id="currentItemName">-</div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;" id="currentItemType">Utensil</div>
                </div>
                <div class="detail-card red">
                    <div class="detail-label">Current Quantity</div>
                    <div class="detail-value" id="currentItemQuantity">0</div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">units</div>
                </div>
            </div>

            <div class="detail-card green" style="margin-bottom: 20px;">
                <div class="detail-label">Recommended Stock Level</div>
                <div class="detail-value" id="recommendedStock">50</div>
                <div style="font-size: 12px; color: #666; margin-top: 5px;">units for optimal inventory</div>
            </div>

            <div class="restock-options">
                <div class="restock-option-card active" id="addStockOption">
                    <div class="restock-icon add">
                        <i class="fas fa-plus-circle"></i>
                    </div>
                    <div class="restock-option-info">
                        <div class="restock-option-title">Add Stock</div>
                        <div class="restock-option-desc">Quickly add more stock to this item</div>
                    </div>
                    <i class="fas fa-check-circle" style="color: #10b981;"></i>
                </div>

                <div class="restock-option-card" id="editItemOption">
                    <div class="restock-icon edit">
                        <i class="fas fa-edit"></i>
                    </div>
                    <div class="restock-option-info">
                        <div class="restock-option-title">Edit Item Details</div>
                        <div class="restock-option-desc">Modify item name, quantity, or category</div>
                    </div>
                </div>
            </div>

            <div class="restock-amount-input show" id="restockAmountInput">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark);">Amount
                        to Add</label>
                    <input type="number" id="quickEditNewQuantity" min="1" max="1000" value="50"
                        style="width: 100%; padding: 12px; border: 2px solid #3b82f6; border-radius: 8px; font-size: 16px; font-weight: 600;">
                </div>

                <div style="margin-bottom: 10px;">
                    <div style="font-size: 13px; color: var(--muted); margin-bottom: 8px;">Quick Add:</div>
                    <div class="amount-buttons">
                        <button class="amount-btn" data-amount="10">+10</button>
                        <button class="amount-btn active" data-amount="50">+50</button>
                        <button class="amount-btn" data-amount="100">+100</button>
                        <button class="amount-btn" data-amount="200">+200</button>
                    </div>
                </div>

                <div
                    style="margin-top: 15px; padding: 12px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <div style="display: flex; justify-content: space-between; font-size: 14px;">
                        <span>New Total:</span>
                        <span style="font-weight: 700; color: #16a34a;" id="newTotalDisplay">0 units</span>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-danger quick-edit-btn" id="cancelQuickEdit">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn-success quick-edit-btn" id="saveQuickEdit">
                    <i class="fas fa-save"></i> Save & Restock
                </button>
            </div>
        </div>
    </div>

    <!-- AI VOICE CONTROLS -->
    <div class="voice-controls">
        <button class="voice-btn" id="toggleVoiceAnnouncements" title="Toggle AI Voice Announcements">
            <i class="fas fa-microphone"></i>
        </button>
        <button class="voice-btn" id="playStatusReport" title="Play Status Report Now">
            <i class="fas fa-volume-up"></i>
        </button>
    </div>

    <!-- ZOOM CONTROLS -->
    <div class="zoom-controls">
        <button class="zoom-btn" id="zoomOut">-</button>
        <div class="zoom-display" id="zoomLevel">100%</div>
        <button class="zoom-btn" id="zoomIn">+</button>
    </div>

    <!-- MODAL FOR ADDING WALK-IN/COMPANY APPOINTMENTS -->
    <div id="walkinModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Walk-In Appointment</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="modal_walkin_patient">Patient Name</label>
                <input id="modal_walkin_patient" type="text" placeholder="Enter patient name">
            </div>
            <div class="form-group">
                <label for="modal_walkin_procedures">Procedures</label>
                <input id="modal_walkin_procedures" type="text" placeholder="Enter procedures (comma separated)">
            </div>
            <div class="form-group">
                <label for="modal_walkin_amount">Amount</label>
                <input id="modal_walkin_amount" type="number" min="0" step="0.01" placeholder="Enter amount"
                    oninput="validateAmount(this)">
            </div>
            <div class="form-group">
                <label for="modal_walkin_date">Date</label>
                <input id="modal_walkin_date" type="date">
            </div>
            <div class="form-group">
                <label for="modal_walkin_contact">Contact</label>
                <input id="modal_walkin_contact" type="text" placeholder="Enter contact number"
                    oninput="validatePhoneNumber(this)">
            </div>
            <div class="form-group">
                <label for="modal_walkin_doctor">Doctor</label>
                <input id="modal_walkin_doctor" type="text" placeholder="Enter doctor name">
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
                <button class="btn-danger" id="cancelWalkin">Cancel</button>
                <button class="btn-success" id="saveWalkin">Save</button>
            </div>
        </div>
    </div>

    <div id="companyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Company Appointment</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="modal_company_patient">Patient Name</label>
                <input id="modal_company_patient" type="text" placeholder="Enter patient name">
            </div>
            <div class="form-group">
                <label for="modal_company_name">Company Name</label>
                <input id="modal_company_name" type="text" placeholder="Enter company name">
            </div>
            <div class="form-group">
                <label for="modal_company_package">Package</label>
                <select id="modal_company_package">
                    <option value>Select Package</option>
                    <option value="B5">B5</option>
                    <option value="B2">B2</option>
                    <option value="B3">B3</option>
                    <option value="B4">B4</option>
                </select>
            </div>
            <div class="form-group">
                <label for="modal_company_amount">Amount</label>
                <input id="modal_company_amount" type="number" min="0" step="0.01" placeholder="Enter amount"
                    oninput="validateAmount(this)">
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
                <button class="btn-danger" id="cancelCompany">Cancel</button>
                <button class="btn-success" id="saveCompany">Save</button>
            </div>
        </div>
    </div>

    <!-- ADD ADMIN MODAL -->
    <div id="addAdminModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Administrator</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="adminFirstName">First Name</label>
                <input id="adminFirstName" type="text" placeholder="Enter first name">
            </div>
            <div class="form-group">
                <label for="adminLastName">Last Name</label>
                <input id="adminLastName" type="text" placeholder="Enter last name">
            </div>
            <div class="form-group">
                <label for="adminPhone">Phone</label>
                <input id="adminPhone" type="text" placeholder="Enter phone number" oninput="validatePhoneNumber(this)">
            </div>
            <div class="form-group">
                <label for="adminUsername">Username</label>
                <input id="adminUsername" type="text" placeholder="Enter username">
            </div>
            <div class="form-group">
                <label for="adminPassword">Password</label>
                <input id="adminPassword" type="password" placeholder="Enter password">
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
                <button class="btn-danger" id="cancelAddAdmin">Cancel</button>
                <button class="btn-success" id="saveAdmin">Save</button>
            </div>
        </div>
    </div>

    <!-- EDIT SUPPLIES MODAL - UPDATED (CATEGORY REMOVED) -->
    <div id="editSuppliesModal" class="edit-utilities-modal">
        <div class="edit-utilities-content">
            <div class="modal-header">
                <h3>Edit Medical Supply Item</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="edit_supply_name">Item Name</label>
                <input id="edit_supply_name" type="text" placeholder="Enter item name">
            </div>
            <div class="form-group">
                <label for="edit_supply_qty">Quantity</label>
                <input id="edit_supply_qty" type="number" min="0" placeholder="Enter quantity">
            </div>
            <div class="form-group">
                <label for="edit_supply_threshold">Low Stock
                    Threshold</label>
                <input id="edit_supply_threshold" type="number" min="1" placeholder="Enter threshold">
            </div>
            <!-- CATEGORY FIELD HAS BEEN REMOVED -->
            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
                <button class="btn-danger" id="cancelEditSupply">Cancel</button>
                <button class="btn-success" id="saveEditSupply">Save
                    Changes</button>
            </div>
        </div>
    </div>

    <!-- EDIT UTENSILS MODAL -->
    <div id="editUtensilsModal" class="edit-utensils-modal">
        <div class="edit-utensils-content">
            <div class="modal-header">
                <h3>Edit Utensil Item</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="edit_utensil_name">Utensil Name</label>
                <input id="edit_utensil_name" type="text" placeholder="Enter utensil name">
            </div>
            <div class="form-group">
                <label for="edit_utensil_qty">Quantity</label>
                <input id="edit_utensil_qty" type="number" min="0" placeholder="Enter quantity">
            </div>
            <div class="form-group">
                <label for="edit_utensil_notes">Notes (Optional)</label>
                <input id="edit_utensil_notes" type="text" placeholder="Enter any notes">
            </div>
            <div class="form-group">
                <label for="edit_utensil_category">Category</label>
                <select id="edit_utensil_category">
                    <option value="kitchen">Kitchen</option>
                    <option value="dining">Dining</option>
                    <option value="cleaning">Cleaning</option>
                    <option value="medical">Medical</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
                <button class="btn-danger" id="cancelEditUtensil">Cancel</button>
                <button class="btn-success" id="saveEditUtensil">Save
                    Changes</button>
            </div>
        </div>
    </div>

    <!-- PREVIEW MODAL -->
    <div id="previewModal" class="preview-modal">
        <div class="preview-content">
            <div class="modal-header">
                <h3>Report Preview</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="previewContent">
                <!-- Preview content will be inserted here -->
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
                <button class="btn-danger" id="closePreview">Close</button>
                <button class="btn-success" id="printFromPreview"><i class="fas fa-print"></i> Print Report</button>
            </div>
        </div>
    </div>

    <!-- CONFIRMATION MODAL -->
    <div id="confirmationModal" class="confirmation-modal">
        <div class="confirmation-content">
            <h3 style="margin-bottom: 15px;">Confirm Deletion</h3>
            <div class="confirmation-text" id="confirmationText">Are you
                sure you want to delete this admin?</div>
            <div class="confirmation-timer" id="confirmationTimer">This
                action will be completed in 5 seconds...</div>
            <div class="confirmation-buttons">
                <button class="btn-danger" id="confirmDelete">Yes,
                    Delete</button>
                <button class="btn-primary" id="cancelDelete">Cancel</button>
            </div>
        </div>
    </div>

    <!-- PRINT SECTION - UPDATED FOR STANDARD A4/LETTER SIZE -->
    <div id="printSection" class="print-section">
        <div style="padding: 20px; font-family: Arial, sans-serif; background: white;">
            <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px;">
                <h1 style="margin: 0; color: #333; font-size: 28px;">St.
                    Michael's Clinic</h1>
                <h2 style="margin: 8px 0; color: #666; font-size: 22px;" id="printReportTitle">Financial Report</h2>
                <p style="margin: 0; color: #999; font-size: 16px;" id="printReportDate">Generated on: </p>
                <p style="margin: 0; color: #999; font-size: 14px;" id="printReportUser">Generated by: </p>
            </div>

            <div id="printReportContent" style="font-size: 14px;">
                <!-- Report content will be inserted here -->
            </div>

            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ccc;">
                <p style="text-align: center; color: #666; font-size: 12px;">
                    Generated by St. Michael's Clinic Admin System
                </p>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ===== GLOBAL VARIABLES =====
        const STORAGE = 'stmike_admin_gold_v1';
        const ADMIN_STORAGE = 'stmike_administrators';
        const REPORTS_STORAGE = 'stmike_reports_v1';
        const SESSION_STORAGE = 'stmike_admin_session';
        const AI_SETTINGS_STORAGE = 'stmike_ai_settings';

        let state = {
            utensils: JSON.parse(localStorage.getItem(STORAGE + '::utensils')) || [],
            supplies: JSON.parse(localStorage.getItem(STORAGE + '::supplies')) || [],
            appointments: JSON.parse(localStorage.getItem(STORAGE + '::appointments')) || [],
            sales: JSON.parse(localStorage.getItem(STORAGE + '::sales')) || [],
            walkins: JSON.parse(localStorage.getItem(STORAGE + '::walkins')) || [],
            companies: JSON.parse(localStorage.getItem(STORAGE + '::companies')) || [],
            reports: JSON.parse(localStorage.getItem(REPORTS_STORAGE)) || []
        };

        let salesChart = null;
        let deleteTimer = null;
        let deleteIndex = null;
        let deleteType = null;
        let currentEditingSupplyIndex = null;
        let currentEditingUtensilIndex = null;
        let currentZoom = 100;
        let speechSynthesis = window.speechSynthesis;
        let aiVoiceEnabled = true;
        let voicePlaying = false;
        let currentUtterance = null;
        let aiNotificationTimeout = null;
        let aiCheckInterval = null;
        let hourlyReminderInterval = null;
        let lastHourlyReminder = 0;
        let currentQuickEditItem = null;
        let quickEditMode = 'add'; // 'add' or 'edit'

        // ===== AI VOICE SETTINGS =====
        const aiSettings = JSON.parse(localStorage.getItem(AI_SETTINGS_STORAGE)) || {
            enabled: true,
            voiceGender: 'male',
            volume: 0.9,
            rate: 1.0,
            pitch: 1.0,
            lastCheck: 0,
            snoozeUntil: 0,
            lastLoginNotification: 0,
            lastHourlyReminder: 0
        };

        // ===== ENHANCED VOICE SYNTHESIS FUNCTIONS =====
        function initializeVoice() {
            if (!speechSynthesis) {
                console.warn('Speech synthesis not supported');
                aiVoiceEnabled = false;
                return;
            }

            speechSynthesis.onvoiceschanged = function () {
                const voices = speechSynthesis.getVoices();
                console.log('Available voices:', voices.length);
            };

            aiVoiceEnabled = aiSettings.enabled;
            updateVoiceButton();

            setTimeout(() => {
                const voices = speechSynthesis.getVoices();
                if (voices.length === 0) {
                    console.warn('No voices available for speech synthesis');
                    aiVoiceEnabled = false;
                }
            }, 1000);
        }

        function speakText(text, callback = null) {
            if (!aiVoiceEnabled || !speechSynthesis) {
                console.log('Voice synthesis disabled or not available');
                return;
            }

            if (document.hidden) {
                console.log('Tab is hidden, skipping speech');
                return;
            }

            stopSpeaking();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.volume = aiSettings.volume;
            utterance.rate = aiSettings.rate;
            utterance.pitch = aiSettings.pitch;

            const voices = speechSynthesis.getVoices();
            let selectedVoice = null;

            // Use male voice for AI (preference for male voice)
            const maleVoices = voices.filter(voice =>
                voice.name.toLowerCase().includes('male') ||
                voice.name.toLowerCase().includes('man') ||
                voice.name.toLowerCase().includes('microsoft david') ||
                voice.name.toLowerCase().includes('google us male') ||
                voice.name.toLowerCase().includes('english male') ||
                voice.name.toLowerCase().includes('english_us male')
            );

            if (maleVoices.length > 0) {
                selectedVoice = maleVoices[0];
                console.log('Using male voice:', selectedVoice.name);
            } else if (voices.length > 0) {
                selectedVoice = voices[0];
                console.log('Using default voice:', selectedVoice.name);
            }

            if (selectedVoice) {
                utterance.voice = selectedVoice;
            } else {
                console.warn('No voice available for speech synthesis');
                return;
            }

            utterance.onstart = function () {
                voicePlaying = true;
                document.getElementById('playStatusReport').classList.add('playing');
                document.getElementById('playVoiceReport').classList.add('playing');
                console.log('Speech started');
            };

            utterance.onend = function () {
                voicePlaying = false;
                document.getElementById('playStatusReport').classList.remove('playing');
                document.getElementById('playVoiceReport').classList.remove('playing');
                console.log('Speech ended');
                if (callback) callback();
            };

            utterance.onerror = function (event) {
                console.error('Speech synthesis error:', event);
                voicePlaying = false;
                document.getElementById('playStatusReport').classList.remove('playing');
                document.getElementById('playVoiceReport').classList.remove('playing');

                if (event.error !== 'interrupted') {
                    showToast('Voice synthesis error. Please check browser permissions.', 'error');
                }
            };

            currentUtterance = utterance;

            setTimeout(() => {
                try {
                    speechSynthesis.speak(utterance);
                } catch (error) {
                    console.error('Error starting speech synthesis:', error);
                    voicePlaying = false;
                    document.getElementById('playStatusReport').classList.remove('playing');
                    document.getElementById('playVoiceReport').classList.remove('playing');
                }
            }, 100);
        }

        function stopSpeaking() {
            if (speechSynthesis) {
                speechSynthesis.cancel();
                voicePlaying = false;
                currentUtterance = null;
                document.getElementById('playStatusReport').classList.remove('playing');
                document.getElementById('playVoiceReport').classList.remove('playing');
                console.log('Speech stopped');
            }
        }

        function toggleVoiceAnnouncements() {
            aiVoiceEnabled = !aiVoiceEnabled;
            aiSettings.enabled = aiVoiceEnabled;
            localStorage.setItem(AI_SETTINGS_STORAGE, JSON.stringify(aiSettings));

            updateVoiceButton();

            if (aiVoiceEnabled) {
                showToast('AI voice announcements enabled', 'success');
                speakText("AI voice announcements enabled. I am ready to assist you.");
                setTimeout(() => checkInventoryAndNotify(true), 500);
            } else {
                showToast('AI voice announcements disabled', 'warning');
                speakText("AI voice announcements disabled.");
                stopSpeaking();
            }
        }

        function updateVoiceButton() {
            const voiceBtn = document.getElementById('toggleVoiceAnnouncements');
            if (aiVoiceEnabled) {
                voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                voiceBtn.style.background = 'linear-gradient(135deg, #1e3c72 0%, #2a5298 100%)';
                voiceBtn.title = 'Disable AI Voice Announcements';
            } else {
                voiceBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                voiceBtn.style.background = 'linear-gradient(135deg, #6b7280 0%, #4b5563 100%)';
                voiceBtn.title = 'Enable AI Voice Announcements';
            }
        }

        // ===== PAGE VISIBILITY HANDLER =====
        function setupPageVisibilityHandler() {
            document.addEventListener('visibilitychange', function () {
                if (document.hidden) {
                    stopSpeaking();
                }
            });

            window.addEventListener('beforeunload', function () {
                stopSpeaking();
            });
        }

        // ===== ENHANCED INVENTORY DETECTION =====
        function checkInventoryStatus() {
            const now = Date.now();
            const oneHour = 60 * 60 * 1000;

            if (now < aiSettings.snoozeUntil) {
                const minutesLeft = Math.ceil((aiSettings.snoozeUntil - now) / 60000);
                console.log(`AI notifications snoozed for ${minutesLeft} more minutes`);
                return null;
            }

            const lowUtensils = state.utensils.filter(utensil => {
                const threshold = 5;
                return utensil.qty <= threshold;
            });

            const lowSupplies = state.supplies.filter(supply => {
                const threshold = supply.threshold || 10;
                return supply.qty <= threshold;
            });

            const criticalItems = [];
            const lowItems = [];

            lowUtensils.forEach(utensil => {
                if (utensil.qty === 0) {
                    criticalItems.push({
                        type: 'utensil',
                        name: utensil.name,
                        quantity: utensil.qty,
                        index: state.utensils.findIndex(u => u.name === utensil.name),
                        threshold: 5,
                        status: 'critical'
                    });
                } else if (utensil.qty <= 2) {
                    criticalItems.push({
                        type: 'utensil',
                        name: utensil.name,
                        quantity: utensil.qty,
                        index: state.utensils.findIndex(u => u.name === utensil.name),
                        threshold: 5,
                        status: 'critical'
                    });
                } else if (utensil.qty <= 5) {
                    lowItems.push({
                        type: 'utensil',
                        name: utensil.name,
                        quantity: utensil.qty,
                        index: state.utensils.findIndex(u => u.name === utensil.name),
                        threshold: 5,
                        status: 'low'
                    });
                }
            });

            lowSupplies.forEach(supply => {
                const threshold = supply.threshold || 10;
                const percentage = (supply.qty / threshold) * 100;

                if (supply.qty === 0) {
                    criticalItems.push({
                        type: 'supply',
                        name: supply.name,
                        quantity: supply.qty,
                        index: state.supplies.findIndex(s => s.name === supply.name),
                        threshold: threshold,
                        status: 'critical'
                    });
                } else if (percentage <= 25) {
                    criticalItems.push({
                        type: 'supply',
                        name: supply.name,
                        quantity: supply.qty,
                        index: state.supplies.findIndex(s => s.name === supply.name),
                        threshold: threshold,
                        status: 'critical'
                    });
                } else if (percentage <= 50) {
                    lowItems.push({
                        type: 'supply',
                        name: supply.name,
                        quantity: supply.qty,
                        index: state.supplies.findIndex(s => s.name === supply.name),
                        threshold: threshold,
                        status: 'low'
                    });
                }
            });

            return {
                criticalItems,
                lowItems,
                hasIssues: criticalItems.length > 0 || lowItems.length > 0,
                lastCheck: now,
                totalUtensils: state.utensils.length,
                totalSupplies: state.supplies.length,
                goodItemsCount: (state.utensils.length + state.supplies.length) - (criticalItems.length + lowItems.length)
            };
        }

        // ===== IMPROVED QUICK EDIT MODAL =====
        function showQuickEditModal(item) {
            currentQuickEditItem = item;
            quickEditMode = 'add'; // Default to add mode

            // Update modal content
            document.getElementById('currentItemName').textContent = item.name;
            document.getElementById('currentItemType').textContent = `(${item.type === 'utensil' ? 'Utensil' : 'Medical Supply'})`;
            document.getElementById('currentItemQuantity').textContent = item.quantity;

            // Set status text and color
            const statusText = document.getElementById('statusText');
            const statusDiv = document.getElementById('quickEditStatus');

            if (item.status === 'critical') {
                statusText.textContent = 'CRITICAL STOCK ALERT - Immediate Action Required';
                statusDiv.style.background = '#fef2f2';
                statusDiv.style.color = '#dc2626';
                statusDiv.querySelector('i').className = 'fas fa-exclamation-triangle';
            } else {
                statusText.textContent = 'LOW STOCK ALERT - Restock Recommended';
                statusDiv.style.background = '#fffbeb';
                statusDiv.style.color = '#d97706';
                statusDiv.querySelector('i').className = 'fas fa-exclamation-circle';
            }

            // Set recommended stock level
            const recommendedStock = Math.max(50, item.threshold * 2);
            document.getElementById('recommendedStock').textContent = recommendedStock;

            // Set default quantity to add
            document.getElementById('quickEditNewQuantity').value = recommendedStock;

            // Calculate and display new total
            updateNewTotalDisplay();

            // Reset to add stock option
            document.getElementById('addStockOption').classList.add('active');
            document.getElementById('editItemOption').classList.remove('active');
            document.getElementById('restockAmountInput').classList.add('show');

            // Show modal
            document.getElementById('quickEditModal').style.display = 'flex';

            // Speak about the item
            if (aiVoiceEnabled) {
                speakText(`${item.name} is ${item.status}. Current quantity is ${item.quantity}. Please add stock or edit the item.`);
            }
        }

        function updateNewTotalDisplay() {
            if (!currentQuickEditItem) return;

            const currentQty = parseInt(currentQuickEditItem.quantity);
            const addQty = parseInt(document.getElementById('quickEditNewQuantity').value) || 0;
            const newTotal = currentQty + addQty;

            document.getElementById('newTotalDisplay').textContent = `${newTotal} units`;

            // Color code based on stock level
            const newTotalDisplay = document.getElementById('newTotalDisplay');
            const threshold = currentQuickEditItem.threshold || 10;

            if (newTotal === 0) {
                newTotalDisplay.style.color = '#dc2626';
            } else if (newTotal <= threshold * 0.25) {
                newTotalDisplay.style.color = '#dc2626';
            } else if (newTotal <= threshold * 0.5) {
                newTotalDisplay.style.color = '#f59e0b';
            } else if (newTotal <= threshold) {
                newTotalDisplay.style.color = '#d97706';
            } else {
                newTotalDisplay.style.color = '#16a34a';
            }
        }

        function saveQuickEdit() {
            if (!currentQuickEditItem) {
                showToast('No item selected', 'error');
                return;
            }

            if (quickEditMode === 'add') {
                saveAddStock();
            } else {
                // For edit mode, open the appropriate edit modal
                document.getElementById('quickEditModal').style.display = 'none';
                if (currentQuickEditItem.type === 'utensil') {
                    editUtensil(currentQuickEditItem.index);
                } else {
                    editSupply(currentQuickEditItem.index);
                }
            }
        }

        function saveAddStock() {
            const addQuantity = parseInt(document.getElementById('quickEditNewQuantity').value);

            if (isNaN(addQuantity) || addQuantity <= 0) {
                showToast('Please enter a valid quantity to add', 'error');
                return;
            }

            if (!currentQuickEditItem) return;

            const { type, index } = currentQuickEditItem;

            if (type === 'utensil' && index !== undefined && index !== -1) {
                // Add stock to existing utensil
                state.utensils[index].qty += addQuantity;

                // Speak confirmation
                if (aiVoiceEnabled) {
                    speakText(`${addQuantity} units added to ${currentQuickEditItem.name}. New total is ${state.utensils[index].qty} units.`);
                }

                showToast(`${addQuantity} units added to ${currentQuickEditItem.name}`, 'success');
            } else if (type === 'supply' && index !== undefined && index !== -1) {
                // Add stock to existing supply
                state.supplies[index].qty += addQuantity;

                // Speak confirmation
                if (aiVoiceEnabled) {
                    speakText(`${addQuantity} units added to ${currentQuickEditItem.name}. New total is ${state.supplies[index].qty} units.`);
                }

                showToast(`${addQuantity} units added to ${currentQuickEditItem.name}`, 'success');
            } else {
                // Item doesn't exist in inventory - add it
                const newQuantity = addQuantity;
                const threshold = currentQuickEditItem.threshold || 10;

                if (type === 'utensil') {
                    state.utensils.push({
                        name: currentQuickEditItem.name,
                        qty: newQuantity,
                        threshold: threshold,
                        category: 'other',
                        notes: 'Added via AI quick restock'
                    });
                } else {
                    state.supplies.push({
                        name: currentQuickEditItem.name,
                        qty: newQuantity,
                        threshold: threshold
                    });
                }

                // Speak confirmation
                if (aiVoiceEnabled) {
                    speakText(`New item ${currentQuickEditItem.name} added to inventory with ${newQuantity} units.`);
                }

                showToast(`New item ${currentQuickEditItem.name} added with ${newQuantity} units`, 'success');
            }

            saveAll();
            renderUtensils();
            renderSupplies();
            updateTopStats();

            document.getElementById('quickEditModal').style.display = 'none';
            currentQuickEditItem = null;

            // Recheck inventory
            setTimeout(() => checkInventoryAndNotify(false), 1000);
        }

        // ===== INVENTORY CHECK AND NOTIFICATION =====
        function checkInventoryAndNotify(isLoginCheck = false) {
            const inventoryStatus = checkInventoryStatus();
            const now = Date.now();

            if (isLoginCheck) {
                showLoginWelcomeNotification(inventoryStatus);
                return;
            }

            if (!inventoryStatus) {
                hideAiNotification();
                return;
            }

            aiSettings.lastCheck = now;
            localStorage.setItem(AI_SETTINGS_STORAGE, JSON.stringify(aiSettings));

            showAiNotification(inventoryStatus, false);

            if (inventoryStatus.criticalItems.length > 0 && aiVoiceEnabled) {
                speakCriticalAlert(inventoryStatus);
            }
        }

        function showLoginWelcomeNotification(inventoryStatus) {
            const panel = document.getElementById('aiNotificationPanel');
            const title = document.getElementById('aiNotificationTitle');
            const content = document.getElementById('aiNotificationContent');
            const inventoryList = document.getElementById('inventoryStatusList');

            const user = getCurrentUser();
            const timeOfDay = getTimeOfDay();

            let notificationText = `Good ${timeOfDay}, ${user.firstName}! Welcome back to St. Michael's Clinic Admin Dashboard. `;

            if (!inventoryStatus || !inventoryStatus.hasIssues) {
                notificationText += `All inventory items are at satisfactory levels. You have ${inventoryStatus?.totalUtensils || 0} utensils and ${inventoryStatus?.totalSupplies || 0} medical supplies in stock. No immediate action required.`;

                title.textContent = "Welcome & System Status";

                inventoryList.innerHTML = `
            <div class="inventory-item">
                <span class="inventory-item-name">All Inventory Items</span>
                <span class="inventory-item-status status-good-badge">Good Status</span>
            </div>
            <div class="inventory-item">
                <span class="inventory-item-name">Total Utensils</span>
                <span class="inventory-item-status status-good-badge">${inventoryStatus?.totalUtensils || 0} items</span>
            </div>
            <div class="inventory-item">
                <span class="inventory-item-name">Total Medical Supplies</span>
                <span class="inventory-item-status status-good-badge">${inventoryStatus?.totalSupplies || 0} items</span>
            </div>
        `;
            } else {
                notificationText += `Inventory status report: `;

                if (inventoryStatus.criticalItems.length > 0) {
                    notificationText += `${inventoryStatus.criticalItems.length} critical items need immediate attention. `;
                }

                if (inventoryStatus.lowItems.length > 0) {
                    notificationText += `${inventoryStatus.lowItems.length} items are running low. `;
                }

                notificationText += `Please click on any item to restock it.`;

                title.textContent = "Welcome & Critical Inventory Alert";

                let inventoryHTML = '';

                if (inventoryStatus.criticalItems.length > 0) {
                    inventoryStatus.criticalItems.forEach(item => {
                        inventoryHTML += `
                    <div class="inventory-item clickable" data-item-type="${item.type}" data-item-name="${escapeHtml(item.name)}" data-item-index="${item.index}" data-item-quantity="${item.quantity}" data-item-threshold="${item.threshold}" data-item-status="${item.status}">
                        <span class="inventory-item-name">${escapeHtml(item.name)}</span>
                        <span class="inventory-item-status status-critical-badge">Critical: ${item.quantity} units</span>
                        <div class="inventory-item-actions">
                            <button class="inventory-action-btn" title="Quick Restock" data-action="restock">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="inventory-action-btn" title="Edit Item" data-action="edit">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>
                `;
                    });
                }

                if (inventoryStatus.lowItems.length > 0) {
                    inventoryStatus.lowItems.forEach(item => {
                        inventoryHTML += `
                    <div class="inventory-item clickable" data-item-type="${item.type}" data-item-name="${escapeHtml(item.name)}" data-item-index="${item.index}" data-item-quantity="${item.quantity}" data-item-threshold="${item.threshold}" data-item-status="${item.status}">
                        <span class="inventory-item-name">${escapeHtml(item.name)}</span>
                        <span class="inventory-item-status status-low-badge">Low: ${item.quantity} units</span>
                        <div class="inventory-item-actions">
                            <button class="inventory-action-btn" title="Quick Restock" data-action="restock">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="inventory-action-btn" title="Edit Item" data-action="edit">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>
                `;
                    });
                }

                if (inventoryStatus.goodItemsCount > 0) {
                    inventoryHTML += `
                <div class="inventory-item">
                    <span class="inventory-item-name">Good Status Items</span>
                    <span class="inventory-item-status status-good-badge">${inventoryStatus.goodItemsCount} items</span>
                </div>
            `;
                }

                inventoryList.innerHTML = inventoryHTML;

                // Add event listeners for clickable items
                setTimeout(() => {
                    document.querySelectorAll('.inventory-item.clickable').forEach(item => {
                        item.addEventListener('click', function () {
                            const itemType = this.dataset.itemType;
                            const itemName = this.dataset.itemName;
                            const itemIndex = parseInt(this.dataset.itemIndex);
                            const itemQuantity = parseInt(this.dataset.itemQuantity);
                            const itemThreshold = parseInt(this.dataset.itemThreshold);
                            const itemStatus = this.dataset.itemStatus;

                            const itemData = {
                                type: itemType,
                                name: itemName,
                                index: itemIndex,
                                quantity: itemQuantity,
                                threshold: itemThreshold,
                                status: itemStatus
                            };

                            showQuickEditModal(itemData);
                        });
                    });

                    // Add event listeners for action buttons
                    document.querySelectorAll('.inventory-action-btn').forEach(btn => {
                        btn.addEventListener('click', function (e) {
                            e.stopPropagation();
                            const action = this.dataset.action;
                            const parent = this.closest('.inventory-item.clickable');

                            if (!parent) return;

                            const itemType = parent.dataset.itemType;
                            const itemName = parent.dataset.itemName;
                            const itemIndex = parseInt(parent.dataset.itemIndex);
                            const itemQuantity = parseInt(parent.dataset.itemQuantity);
                            const itemThreshold = parseInt(parent.dataset.itemThreshold);
                            const itemStatus = parent.dataset.itemStatus;

                            const itemData = {
                                type: itemType,
                                name: itemName,
                                index: itemIndex,
                                quantity: itemQuantity,
                                threshold: itemThreshold,
                                status: itemStatus
                            };

                            if (action === 'restock') {
                                showQuickEditModal(itemData);
                            } else if (action === 'edit') {
                                document.getElementById('quickEditModal').style.display = 'none';
                                if (itemType === 'utensil') {
                                    editUtensil(itemIndex);
                                } else {
                                    editSupply(itemIndex);
                                }
                            }
                        });
                    });
                }, 100);
            }

            content.innerHTML = notificationText;
            panel.classList.add('show');

            aiSettings.lastLoginNotification = Date.now();
            localStorage.setItem(AI_SETTINGS_STORAGE, JSON.stringify(aiSettings));

            clearTimeout(aiNotificationTimeout);
            aiNotificationTimeout = setTimeout(() => {
                hideAiNotification();
            }, 30000);

            if (aiVoiceEnabled) {
                speakText(notificationText);
            }
        }

        function getTimeOfDay() {
            const hour = new Date().getHours();
            if (hour < 12) return 'morning';
            if (hour < 18) return 'afternoon';
            return 'evening';
        }

        function showHourlyReminderNotification() {
            const now = Date.now();
            const oneHour = 60 * 60 * 1000;

            if (now - aiSettings.lastHourlyReminder < oneHour) {
                return;
            }

            const inventoryStatus = checkInventoryStatus();
            const panel = document.getElementById('aiNotificationPanel');
            const title = document.getElementById('aiNotificationTitle');
            const content = document.getElementById('aiNotificationContent');
            const inventoryList = document.getElementById('inventoryStatusList');

            let notificationText = `Hourly Reminder: Inventory Status Update. `;

            if (!inventoryStatus || !inventoryStatus.hasIssues) {
                notificationText += `All inventory items are still at satisfactory levels. Continue monitoring.`;

                title.textContent = "Hourly Reminder - All Good";

                inventoryList.innerHTML = `
            <div class="inventory-item">
                <span class="inventory-item-name">All Inventory Items</span>
                <span class="inventory-item-status status-good-badge">Good Status</span>
            </div>
        `;
            } else {
                notificationText += `Current status: `;

                if (inventoryStatus.criticalItems.length > 0) {
                    notificationText += `${inventoryStatus.criticalItems.length} critical items still need attention. `;
                }

                if (inventoryStatus.lowItems.length > 0) {
                    notificationText += `${inventoryStatus.lowItems.length} items are still low. `;
                }

                notificationText += `Click on any item below to restock it.`;

                title.textContent = "Hourly Reminder - Action Needed";

                let inventoryHTML = '';

                if (inventoryStatus.criticalItems.length > 0) {
                    inventoryStatus.criticalItems.forEach(item => {
                        inventoryHTML += `
                    <div class="inventory-item clickable" data-item-type="${item.type}" data-item-name="${escapeHtml(item.name)}" data-item-index="${item.index}" data-item-quantity="${item.quantity}" data-item-threshold="${item.threshold}" data-item-status="${item.status}">
                        <span class="inventory-item-name">${escapeHtml(item.name)}</span>
                        <span class="inventory-item-status status-critical-badge">Critical: ${item.quantity} units</span>
                        <div class="inventory-item-actions">
                            <button class="inventory-action-btn" title="Quick Restock" data-action="restock">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="inventory-action-btn" title="Edit Item" data-action="edit">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>
                `;
                    });
                }

                if (inventoryStatus.lowItems.length > 0) {
                    inventoryStatus.lowItems.forEach(item => {
                        inventoryHTML += `
                    <div class="inventory-item clickable" data-item-type="${item.type}" data-item-name="${escapeHtml(item.name)}" data-item-index="${item.index}" data-item-quantity="${item.quantity}" data-item-threshold="${item.threshold}" data-item-status="${item.status}">
                        <span class="inventory-item-name">${escapeHtml(item.name)}</span>
                        <span class="inventory-item-status status-low-badge">Low: ${item.quantity} units</span>
                        <div class="inventory-item-actions">
                            <button class="inventory-action-btn" title="Quick Restock" data-action="restock">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="inventory-action-btn" title="Edit Item" data-action="edit">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>
                `;
                    });
                }

                inventoryList.innerHTML = inventoryHTML;

                // Add event listeners
                setTimeout(() => {
                    document.querySelectorAll('.inventory-item.clickable').forEach(item => {
                        item.addEventListener('click', function () {
                            const itemType = this.dataset.itemType;
                            const itemName = this.dataset.itemName;
                            const itemIndex = parseInt(this.dataset.itemIndex);
                            const itemQuantity = parseInt(this.dataset.itemQuantity);
                            const itemThreshold = parseInt(this.dataset.itemThreshold);
                            const itemStatus = this.dataset.itemStatus;

                            const itemData = {
                                type: itemType,
                                name: itemName,
                                index: itemIndex,
                                quantity: itemQuantity,
                                threshold: itemThreshold,
                                status: itemStatus
                            };

                            showQuickEditModal(itemData);
                        });
                    });

                    document.querySelectorAll('.inventory-action-btn').forEach(btn => {
                        btn.addEventListener('click', function (e) {
                            e.stopPropagation();
                            const action = this.dataset.action;
                            const parent = this.closest('.inventory-item.clickable');

                            if (!parent) return;

                            const itemType = parent.dataset.itemType;
                            const itemName = parent.dataset.itemName;
                            const itemIndex = parseInt(parent.dataset.itemIndex);
                            const itemQuantity = parseInt(parent.dataset.itemQuantity);
                            const itemThreshold = parseInt(parent.dataset.itemThreshold);
                            const itemStatus = parent.dataset.itemStatus;

                            const itemData = {
                                type: itemType,
                                name: itemName,
                                index: itemIndex,
                                quantity: itemQuantity,
                                threshold: itemThreshold,
                                status: itemStatus
                            };

                            if (action === 'restock') {
                                showQuickEditModal(itemData);
                            } else if (action === 'edit') {
                                document.getElementById('quickEditModal').style.display = 'none';
                                if (itemType === 'utensil') {
                                    editUtensil(itemIndex);
                                } else {
                                    editSupply(itemIndex);
                                }
                            }
                        });
                    });
                }, 100);
            }

            content.innerHTML = notificationText;
            panel.classList.add('show');

            aiSettings.lastHourlyReminder = now;
            localStorage.setItem(AI_SETTINGS_STORAGE, JSON.stringify(aiSettings));

            clearTimeout(aiNotificationTimeout);
            aiNotificationTimeout = setTimeout(() => {
                hideAiNotification();
            }, 30000);
        }

        function showAiNotification(inventoryStatus, isHourlyReminder = false) {
            const panel = document.getElementById('aiNotificationPanel');
            const title = document.getElementById('aiNotificationTitle');
            const content = document.getElementById('aiNotificationContent');
            const inventoryList = document.getElementById('inventoryStatusList');

            let notificationText = '';
            let inventoryHTML = '';

            if (inventoryStatus.criticalItems.length > 0) {
                notificationText += `Critical Alert: ${inventoryStatus.criticalItems.length} items need immediate attention. `;

                inventoryStatus.criticalItems.forEach(item => {
                    inventoryHTML += `
                <div class="inventory-item clickable" data-item-type="${item.type}" data-item-name="${escapeHtml(item.name)}" data-item-index="${item.index}" data-item-quantity="${item.quantity}" data-item-threshold="${item.threshold}" data-item-status="${item.status}">
                    <span class="inventory-item-name">${escapeHtml(item.name)}</span>
                    <span class="inventory-item-status status-critical-badge">Critical: ${item.quantity} units</span>
                    <div class="inventory-item-actions">
                        <button class="inventory-action-btn" title="Quick Restock" data-action="restock">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="inventory-action-btn" title="Edit Item" data-action="edit">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </div>
            `;
                });
            }

            if (inventoryStatus.lowItems.length > 0) {
                notificationText += `${inventoryStatus.lowItems.length} items are running low. `;

                inventoryStatus.lowItems.forEach(item => {
                    inventoryHTML += `
                <div class="inventory-item clickable" data-item-type="${item.type}" data-item-name="${escapeHtml(item.name)}" data-item-index="${item.index}" data-item-quantity="${item.quantity}" data-item-threshold="${item.threshold}" data-item-status="${item.status}">
                    <span class="inventory-item-name">${escapeHtml(item.name)}</span>
                    <span class="inventory-item-status status-low-badge">Low: ${item.quantity} units</span>
                    <div class="inventory-item-actions">
                        <button class="inventory-action-btn" title="Quick Restock" data-action="restock">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="inventory-action-btn" title="Edit Item" data-action="edit">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </div>
            `;
                });
            }

            notificationText += `Click on any item to restock it.`;

            if (isHourlyReminder) {
                title.textContent = "Hourly Reminder - Inventory Status";
            } else {
                title.textContent = inventoryStatus.criticalItems.length > 0 ? "Critical Inventory Alert" : "Low Inventory Alert";
            }

            content.innerHTML = notificationText;
            inventoryList.innerHTML = inventoryHTML;

            // Add event listeners
            setTimeout(() => {
                document.querySelectorAll('.inventory-item.clickable').forEach(item => {
                    item.addEventListener('click', function () {
                        const itemType = this.dataset.itemType;
                        const itemName = this.dataset.itemName;
                        const itemIndex = parseInt(this.dataset.itemIndex);
                        const itemQuantity = parseInt(this.dataset.itemQuantity);
                        const itemThreshold = parseInt(this.dataset.itemThreshold);
                        const itemStatus = this.dataset.itemStatus;

                        const itemData = {
                            type: itemType,
                            name: itemName,
                            index: itemIndex,
                            quantity: itemQuantity,
                            threshold: itemThreshold,
                            status: itemStatus
                        };

                        showQuickEditModal(itemData);
                    });
                });

                document.querySelectorAll('.inventory-action-btn').forEach(btn => {
                    btn.addEventListener('click', function (e) {
                        e.stopPropagation();
                        const action = this.dataset.action;
                        const parent = this.closest('.inventory-item.clickable');

                        if (!parent) return;

                        const itemType = parent.dataset.itemType;
                        const itemName = parent.dataset.itemName;
                        const itemIndex = parseInt(parent.dataset.itemIndex);
                        const itemQuantity = parseInt(parent.dataset.itemQuantity);
                        const itemThreshold = parseInt(parent.dataset.itemThreshold);
                        const itemStatus = parent.dataset.itemStatus;

                        const itemData = {
                            type: itemType,
                            name: itemName,
                            index: itemIndex,
                            quantity: itemQuantity,
                            threshold: itemThreshold,
                            status: itemStatus
                        };

                        if (action === 'restock') {
                            showQuickEditModal(itemData);
                        } else if (action === 'edit') {
                            document.getElementById('quickEditModal').style.display = 'none';
                            if (itemType === 'utensil') {
                                editUtensil(itemIndex);
                            } else {
                                editSupply(itemIndex);
                            }
                        }
                    });
                });
            }, 100);

            panel.classList.add('show');

            if (inventoryStatus.criticalItems.length === 0) {
                clearTimeout(aiNotificationTimeout);
                aiNotificationTimeout = setTimeout(() => {
                    hideAiNotification();
                }, 30000);
            }
        }

        function hideAiNotification() {
            const panel = document.getElementById('aiNotificationPanel');
            panel.classList.remove('show');
        }

        function speakCriticalAlert(inventoryStatus) {
            let alertMessage = "Critical inventory alert. Attention required. ";

            if (inventoryStatus.criticalItems.length > 0) {
                alertMessage += `There are ${inventoryStatus.criticalItems.length} critically low items. `;

                inventoryStatus.criticalItems.slice(0, 3).forEach(item => {
                    alertMessage += `${item.name} has only ${item.quantity} units left. `;
                });

                if (inventoryStatus.criticalItems.length > 3) {
                    alertMessage += `And ${inventoryStatus.criticalItems.length - 3} more items. `;
                }
            }

            if (inventoryStatus.lowItems.length > 0) {
                alertMessage += `Additionally, ${inventoryStatus.lowItems.length} items are running low. `;
            }

            alertMessage += "Please take immediate action to restock these items. Click on any item to add stock.";

            speakText(alertMessage);
        }

        function speakStatusReport() {
            const inventoryStatus = checkInventoryStatus();

            if (!inventoryStatus) {
                const message = "Notifications are currently snoozed. Check back later.";
                speakText(message);
                showToast("Notifications are snoozed", "info");
                return;
            }

            if (!inventoryStatus.hasIssues) {
                const message = "All inventory items are at satisfactory levels. No immediate action required. You have " +
                    inventoryStatus.totalUtensils + " utensils and " +
                    inventoryStatus.totalSupplies + " medical supplies in stock.";
                speakText(message);
                showToast("All items are at satisfactory levels", "success");
            } else {
                let reportMessage = "Current inventory status report. ";

                if (inventoryStatus.criticalItems.length > 0) {
                    reportMessage += `Critical items: ${inventoryStatus.criticalItems.length}. `;
                    inventoryStatus.criticalItems.forEach(item => {
                        reportMessage += `${item.name}: ${item.quantity} units. `;
                    });
                }

                if (inventoryStatus.lowItems.length > 0) {
                    reportMessage += `Low items: ${inventoryStatus.lowItems.length}. `;
                    inventoryStatus.lowItems.slice(0, 3).forEach(item => {
                        reportMessage += `${item.name}: ${item.quantity} units. `;
                    });

                    if (inventoryStatus.lowItems.length > 3) {
                        reportMessage += `And ${inventoryStatus.lowItems.length - 3} more items. `;
                    }
                }

                reportMessage += "Please click on any item to restock or edit. Inventory needs attention.";

                try {
                    speakText(reportMessage);
                } catch (error) {
                    console.error('Error speaking status report:', error);
                    showToast('Could not play voice report. Check browser permissions.', 'error');
                }
            }
        }

        function quickRestockAll() {
            const inventoryStatus = checkInventoryStatus();

            if (!inventoryStatus || !inventoryStatus.hasIssues) {
                showToast('No items need restocking', 'info');
                if (aiVoiceEnabled) {
                    speakText("All items are already at satisfactory levels. No restocking needed.");
                }
                return;
            }

            let restockedCount = 0;
            const itemsToRestock = [...inventoryStatus.criticalItems, ...inventoryStatus.lowItems];

            itemsToRestock.forEach(item => {
                const { type, index } = item;

                if (type === 'utensil' && index !== undefined && index !== -1) {
                    state.utensils[index].qty += 50;
                    if (state.utensils[index].threshold === undefined) {
                        state.utensils[index].threshold = 20;
                    }
                    restockedCount++;
                } else if (type === 'supply' && index !== undefined && index !== -1) {
                    state.supplies[index].qty += 50;
                    state.supplies[index].threshold = state.supplies[index].threshold || 20;
                    restockedCount++;
                }
            });

            if (restockedCount > 0) {
                saveAll();
                renderUtensils();
                renderSupplies();
                updateTopStats();

                // Speak confirmation
                if (aiVoiceEnabled) {
                    speakText(`${restockedCount} items have been successfully restocked. All items now have sufficient stock. Inventory updated.`);
                }

                showToast(`${restockedCount} items restocked successfully`, 'success');
                hideAiNotification();

                // Recheck inventory
                setTimeout(() => checkInventoryAndNotify(false), 1000);
            }
        }

        function snoozeNotifications() {
            const oneHour = 60 * 60 * 1000;
            aiSettings.snoozeUntil = Date.now() + oneHour;
            localStorage.setItem(AI_SETTINGS_STORAGE, JSON.stringify(aiSettings));

            hideAiNotification();
            showToast('Notifications snoozed for 1 hour', 'success');

            if (aiVoiceEnabled) {
                speakText("Notifications have been snoozed for one hour.");
            }
        }

        // ===== HOURLY REMINDER SYSTEM =====
        function setupHourlyReminders() {
            if (hourlyReminderInterval) {
                clearInterval(hourlyReminderInterval);
            }

            hourlyReminderInterval = setInterval(() => {
                showHourlyReminderNotification();
            }, 60 * 60 * 1000);

            updateHourlyReminderIndicator();
        }

        function updateHourlyReminderIndicator() {
            const indicator = document.getElementById('hourlyReminderIndicator');
            if (aiVoiceEnabled && !(Date.now() < aiSettings.snoozeUntil)) {
                indicator.style.display = 'block';
            } else {
                indicator.style.display = 'none';
            }
        }

        // ===== PROCEDURE TO UTILITY MAPPING =====
        const procedureUtilityMapping = {
            // Blood Chemistry Procedures
            "Fasting Blood Sugar (FBS)": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "Random Blood Sugar (RSS)": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "Oral Glucose Challenge Test (OGCT)": ["Blood Test Kit", "Syringe", "Alcohol Swab", "Glucose Solution"],
            "Oral Glucose Tolerance Test (OGTT)": ["Blood Test Kit", "Syringe", "Alcohol Swab", "Glucose Solution"],
            "Blood Urea Nitrogen (BUN)": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "Creatinine": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "Blood Uric Acid (BUA)": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "Cholesterol": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "Triglycerides": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "Lipid Profile": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "HDL Cholesterol": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "LDL Cholesterol": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "VLDL Cholesterol": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "Total Bilirubin": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "Direct Bilirubin": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "Indirect Bilirubin": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "Total Protein": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "Albumin": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "Total Protein Albumin Globulin (TPAG)": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "Glycated Hemoglobin (HbA1c) with machine print out & graph": ["Blood Test Kit", "Syringe", "Alcohol Swab"],

            // Enzymes
            "Alanine Aminotransferase (SGPT/ALT)": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "Aspartate Aminotransferase (SGOT/AST)": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "Gamma Glutamyl Transferase (GGTP)": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "Alkaline Phosphatase": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "Acid Phosphatase": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "Amylase": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "Lipase": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "Total Creatine Phosphokinase (CPK)": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "CPK-MB Isoenzyme": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "CPK-MM Isoenzyme": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "Troponin I Qualitative (Serum)": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "Troponin T Qualitative (EDTA)": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "Lactate Dehydrogenase (LDH)": ["Blood Test Kit", "Syringe", "Alcohol Swab"],

            // Hematology
            "Complete Blood Count (CBC)": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "CBC with Indices (MCV, MCH, MCHC)": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "Platelet Count": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "Hemoglobin & Hematocrit": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "Reticulocyte Count": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "Erythrocyte Sedimentation Rate (ESR)": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "ABO Blood Typing": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "Peripheral Blood Smear (PBS)": ["Blood Test Kit", "Syringe", "Alcohol Swab", "Microscope Slide"],
            "Malarial Smear": ["Blood Test Kit", "Syringe", "Alcohol Swab", "Microscope Slide"],
            "Lupus Erythematosus (LE) Screening": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "Prothrombin Time (Protime)": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "Activated Partial Thromboplastin Time (APTT)": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "Coombs Test": ["Blood Test Kit", "Syringe", "Alcohol Swab"],
            "Rh Factor": ["Blood Test Kit", "Syringe", "Alcohol Swab"],

            // Clinical Microscopy
            "Urinalysis": ["Urine Cup", "Test Strip"],
            "Urobilinogen": ["Urine Cup", "Test Strip"],
            "Ketone/Acetone": ["Urine Cup", "Test Strip"],
            "Bile/Nitrates/Bilirubin": ["Urine Cup", "Test Strip"],
            "Sugar": ["Urine Cup", "Test Strip"],
            "Micro-Albumin Test": ["Urine Cup", "Test Strip"],
            "Pregnancy Test (Serum)": ["Blood Test Kit", "Syringe", "Alcohol Swab", "Pregnancy Test Kit"],
            "Pregnancy Test (Urine)": ["Urine Cup", "Pregnancy Test Kit"],
            "Fecalysis": ["Stool Container", "Test Kit"],
            "Occult Blood": ["Stool Container", "Test Kit"],
            "Body Fluids Analysis (Pleural, Peritoneal, CSF)": ["Syringe", "Alcohol Swab", "Test Tube"],
            "Cell Differential Count": ["Syringe", "Alcohol Swab", "Microscope Slide"],
            "Sugar in Body Fluids": ["Syringe", "Alcohol Swab", "Test Strip"],
            "Protein in Body Fluids": ["Syringe", "Alcohol Swab", "Test Strip"],
            "Semen Analysis": ["Semen Container", "Microscope Slide"],
            "Stone Analysis (Urinary)": ["Specimen Container"],

            // Other Common Procedures
            "Electrocardiogram (ECG)": ["ECG Machine", "ECG Electrodes", "ECG Paper"],
            "Pap Smear": ["Speculum", "Cytology Brush", "Microscope Slide"],
            "HIV Test DOH Accredited Screening": ["Blood Test Kit", "Syringe", "Alcohol Swab", "HIV Test Kit"],
            "HIV Test DOH Accredited with Titer (ELISA)": ["Blood Test Kit", "Syringe", "Alcohol Swab", "HIV Test Kit"]
        };

        // ===== ZOOM FUNCTIONALITY =====
        function setupZoomControls() {
            const zoomInBtn = document.getElementById('zoomIn');
            const zoomOutBtn = document.getElementById('zoomOut');
            const zoomLevelDisplay = document.getElementById('zoomLevel');

            zoomInBtn.addEventListener('click', () => {
                if (currentZoom < 150) {
                    currentZoom += 10;
                    updateZoom();
                }
            });

            zoomOutBtn.addEventListener('click', () => {
                if (currentZoom > 70) {
                    currentZoom -= 10;
                    updateZoom();
                }
            });

            updateZoom();
        }

        function updateZoom() {
            document.body.style.zoom = `${currentZoom}%`;
            document.getElementById('zoomLevel').textContent = `${currentZoom}%`;
        }

        // ===== USER SESSION MANAGEMENT =====
        function getCurrentUser() {
            const session = JSON.parse(localStorage.getItem(SESSION_STORAGE) || '{}');

            if (session.username) {
                return {
                    username: session.username,
                    firstName: session.firstName || session.username,
                    fullName: session.fullName || session.username
                };
            }

            const urlParams = new URLSearchParams(window.location.search);
            const username = urlParams.get('username') || 'Admin';
            const firstName = urlParams.get('firstName') || username;

            return {
                username: username,
                firstName: firstName,
                fullName: firstName
            };
        }

        function updateUserDisplay() {
            const user = getCurrentUser();

            document.getElementById('currentUserName').textContent = user.firstName;
            document.getElementById('signedInAs').innerHTML = `Signed in as <strong style="color:var(--gold-3)">${user.firstName}</strong>`;
            document.getElementById('welcomeMessage').textContent = `Welcome to St. Michael's Clinic Admin Portal, ${user.firstName}!`;

            const session = JSON.parse(localStorage.getItem(SESSION_STORAGE) || '{}');
            session.username = user.username;
            session.firstName = user.firstName;
            session.fullName = user.fullName;
            localStorage.setItem(SESSION_STORAGE, JSON.stringify(session));
        }

        // ===== MULTI-TAB SYNC FUNCTIONS =====
        function setupMultiTabSync() {
            window.addEventListener('storage', function (e) {
                if (e.key === SESSION_STORAGE) {
                    const sessionData = JSON.parse(e.newValue || '{}');
                    if (sessionData && sessionData.loggedOut) {
                        showToast('Logged out from another tab', 'warning');
                        setTimeout(() => {
                            window.location.href = 'Login.html';
                        }, 2000);
                    }
                }

                if (e.key && (e.key.startsWith('stmike_') || e.key.includes('::'))) {
                    setTimeout(() => {
                        loadStateFromStorage();
                        renderAll();
                        updateTopStats();
                        if (salesChart) refreshChart();
                        showToast('Data updated from another tab', 'success');
                    }, 100);
                }
            });

            setInterval(() => {
                const session = JSON.parse(localStorage.getItem(SESSION_STORAGE) || '{}');
                if (!session.loggedIn || session.loggedOut) {
                    showToast('Session expired', 'error');
                    setTimeout(() => {
                        window.location.href = 'Login.html';
                    }, 1000);
                }
            }, 5000);
        }

        function loadStateFromStorage() {
            state = {
                utensils: JSON.parse(localStorage.getItem(STORAGE + '::utensils')) || [],
                supplies: JSON.parse(localStorage.getItem(STORAGE + '::supplies')) || [],
                appointments: JSON.parse(localStorage.getItem(STORAGE + '::appointments')) || [],
                sales: JSON.parse(localStorage.getItem(STORAGE + '::sales')) || [],
                walkins: JSON.parse(localStorage.getItem(STORAGE + '::walkins')) || [],
                companies: JSON.parse(localStorage.getItem(STORAGE + '::companies')) || [],
                reports: JSON.parse(localStorage.getItem(REPORTS_STORAGE)) || []
            };
        }

        // ===== ENHANCED LOGOUT =====
        function enhancedLogout() {
            stopSpeaking();

            if (hourlyReminderInterval) {
                clearInterval(hourlyReminderInterval);
                hourlyReminderInterval = null;
            }
            if (aiCheckInterval) {
                clearInterval(aiCheckInterval);
                aiCheckInterval = null;
            }

            if (aiNotificationTimeout) {
                clearTimeout(aiNotificationTimeout);
                aiNotificationTimeout = null;
            }

            if (speechSynthesis && speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }

            voicePlaying = false;
            currentUtterance = null;

            const session = {
                loggedIn: false,
                loggedOut: true,
                timestamp: Date.now(),
                username: getCurrentUser().username
            };
            localStorage.setItem(SESSION_STORAGE, JSON.stringify(session));

            localStorage.removeItem('stmike_admin_temp_data');

            showToast('Logout successful!', 'success');
            setTimeout(() => {
                window.location.href = 'Login.html';
            }, 1000);
        }

        // ===== INPUT VALIDATION FUNCTIONS =====
        function validateAmount(input) {
            input.value = input.value.replace(/[^\d.]/g, '');

            const parts = input.value.split('.');
            if (parts.length > 2) {
                input.value = parts[0] + '.' + parts.slice(1).join('');
            }

            if (parts.length > 1 && parts[1].length > 2) {
                input.value = parts[0] + '.' + parts[1].substring(0, 2);
            }

            if (parseFloat(input.value) < 0) {
                input.value = '0';
            }
        }

        function validatePhoneNumber(input) {
            let numbers = input.value.replace(/\D/g, '');
            numbers = numbers.substring(0, 11);

            if (numbers.length > 7) {
                input.value = numbers.substring(0, 4) + ' ' + numbers.substring(4, 7) + ' ' + numbers.substring(7);
            } else if (numbers.length > 4) {
                input.value = numbers.substring(0, 4) + ' ' + numbers.substring(4);
            } else {
                input.value = numbers;
            }
        }

        function setupInputValidation() {
            document.addEventListener('paste', function (e) {
                if (e.target.type === 'number' || e.target.hasAttribute('oninput')) {
                    e.preventDefault();
                    const text = e.clipboardData.getData('text');
                    const numbers = text.replace(/[^\d.]/g, '');
                    document.execCommand('insertText', false, numbers);
                }
            });

            document.addEventListener('DOMContentLoaded', function () {
                const amountFields = document.querySelectorAll('input[type="number"]');
                amountFields.forEach(field => {
                    if (!field.hasAttribute('oninput')) {
                        field.setAttribute('oninput', 'validateAmount(this)');
                    }
                });
            });
        }

        // ===== REAL TIME CLOCK FUNCTION =====
        function updateTime() {
            const now = new Date();

            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const formattedDate = now.toLocaleDateString('en-US', options);

            let hours = now.getHours();
            let minutes = now.getMinutes();
            let seconds = now.getSeconds();
            const ampm = hours >= 12 ? 'PM' : 'AM';

            hours = hours % 12;
            hours = hours ? hours : 12;
            minutes = minutes < 10 ? '0' + minutes : minutes;
            seconds = seconds < 10 ? '0' + seconds : seconds;

            const formattedTime = `${hours}:${minutes}:${seconds} ${ampm}`;

            document.getElementById('todayDate').textContent = formattedDate;
            document.getElementById('realTime').textContent = formattedTime;
        }

        // ===== ADMIN DASHBOARD FUNCTIONS =====
        function saveAll() {
            localStorage.setItem(STORAGE + '::utensils', JSON.stringify(state.utensils));
            localStorage.setItem(STORAGE + '::supplies', JSON.stringify(state.supplies));
            localStorage.setItem(STORAGE + '::appointments', JSON.stringify(state.appointments));
            localStorage.setItem(STORAGE + '::sales', JSON.stringify(state.sales));
            localStorage.setItem(STORAGE + '::walkins', JSON.stringify(state.walkins));
            localStorage.setItem(STORAGE + '::companies', JSON.stringify(state.companies));
            localStorage.setItem(REPORTS_STORAGE, JSON.stringify(state.reports));

            window.dispatchEvent(new Event('storage'));

            setTimeout(() => checkInventoryAndNotify(false), 500);
        }

        function initAdminDashboard() {
            const user = getCurrentUser();
            const session = {
                loggedIn: true,
                timestamp: Date.now(),
                username: user.username,
                firstName: user.firstName,
                fullName: user.fullName
            };
            localStorage.setItem(SESSION_STORAGE, JSON.stringify(session));

            updateUserDisplay();

            renderAll();
            bindAdminUI();
            initNav();
            buildChart();
            updateTime();
            setInterval(updateTime, 1000);
            setupMultiTabSync();
            setupInputValidation();
            setupZoomControls();
            initializeVoice();
            setupPageVisibilityHandler();

            setupAiVoiceControls();
            setupHourlyReminders();

            document.getElementById('appt_date').value = new Date().toISOString().slice(0, 10);
            document.getElementById('modal_walkin_date').value = new Date().toISOString().slice(0, 10);

            setTimeout(() => {
                checkInventoryAndNotify(true);

                aiCheckInterval = setInterval(() => checkInventoryAndNotify(false), 5 * 60 * 1000);
            }, 2000);
        }

        function setupAiVoiceControls() {
            document.getElementById('toggleVoiceAnnouncements').addEventListener('click', function () {
                toggleVoiceAnnouncements();
            });

            document.getElementById('playStatusReport').addEventListener('click', function () {
                if (voicePlaying) {
                    stopSpeaking();
                    showToast('Voice stopped', 'warning');
                } else {
                    speakStatusReport();
                }
            });

            document.getElementById('playVoiceReport').addEventListener('click', function () {
                if (voicePlaying) {
                    stopSpeaking();
                    showToast('Voice stopped', 'warning');
                } else {
                    speakStatusReport();
                }
            });

            document.getElementById('snoozeNotification').addEventListener('click', snoozeNotifications);

            document.getElementById('quickRestockAll').addEventListener('click', quickRestockAll);

            document.getElementById('closeAiNotification').addEventListener('click', function () {
                hideAiNotification();
                stopSpeaking();
            });

            // Improved quick edit modal events
            document.getElementById('saveQuickEdit').addEventListener('click', saveQuickEdit);
            document.getElementById('cancelQuickEdit').addEventListener('click', function () {
                document.getElementById('quickEditModal').style.display = 'none';
                currentQuickEditItem = null;
            });

            // Add stock option click
            document.getElementById('addStockOption').addEventListener('click', function () {
                quickEditMode = 'add';
                document.getElementById('addStockOption').classList.add('active');
                document.getElementById('editItemOption').classList.remove('active');
                document.getElementById('restockAmountInput').classList.add('show');
                document.getElementById('saveQuickEdit').innerHTML = '<i class="fas fa-save"></i> Save & Restock';
            });

            // Edit item option click
            document.getElementById('editItemOption').addEventListener('click', function () {
                quickEditMode = 'edit';
                document.getElementById('editItemOption').classList.add('active');
                document.getElementById('addStockOption').classList.remove('active');
                document.getElementById('restockAmountInput').classList.remove('show');
                document.getElementById('saveQuickEdit').innerHTML = '<i class="fas fa-edit"></i> Edit Item';
            });

            // Quick amount buttons
            document.querySelectorAll('.amount-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const amount = parseInt(this.dataset.amount);
                    document.getElementById('quickEditNewQuantity').value = amount;

                    // Update active state
                    document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    updateNewTotalDisplay();
                });
            });

            // Quantity input change
            document.getElementById('quickEditNewQuantity').addEventListener('input', updateNewTotalDisplay);

            // Close quick edit modal
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', function () {
                    document.getElementById('quickEditModal').style.display = 'none';
                    currentQuickEditItem = null;
                });
            });
        }

        function initNav() {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const tgt = btn.dataset.target;
                    document.querySelectorAll('main section').forEach(s => s.style.display = 'none');
                    document.getElementById(tgt).style.display = 'block';
                });
            });
        }

        function escapeHtml(s) { return String(s || '').replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;'); }

        function renderAll() {
            renderUtensils();
            renderSupplies();
            renderAppointments();
            renderAdministrators();
            renderSales();
            renderWalkins();
            renderCompanies();
            renderReports();
            renderAppointmentHistory();
            updateTopStats();
            updateReportTotals();
        }

        // ===== SAVE TO HISTORY FUNCTIONS =====
        function saveWalkinToHistory() {
            document.getElementById('walkinModal').style.display = 'flex';
        }

        function saveCompanyToHistory() {
            document.getElementById('companyModal').style.display = 'flex';
        }

        function saveWalkinFromModal() {
            const patient = document.getElementById('modal_walkin_patient').value.trim();
            const procedures = document.getElementById('modal_walkin_procedures').value.split(',').map(p => p.trim()).filter(p => p);
            const amount = Number(document.getElementById('modal_walkin_amount').value || 0);
            const date = document.getElementById('modal_walkin_date').value;
            const contact = document.getElementById('modal_walkin_contact').value.trim();
            const doctor = document.getElementById('modal_walkin_doctor').value.trim();

            if (!patient || procedures.length === 0 || amount <= 0 || !date || !contact || !doctor) {
                showToast('Please fill all fields with valid values', 'error');
                return;
            }

            const newWalkin = {
                number: state.walkins.length + 1,
                patient_name: patient,
                procedures: procedures,
                amount: amount,
                date: date,
                contact: contact,
                doctor_name: doctor,
                created_by: getCurrentUser().username
            };

            state.walkins.push(newWalkin);
            saveAll();
            renderWalkins();
            renderAppointmentHistory();
            updateTopStats();
            updateReportTotals();
            showToast('Walk-In saved to history', 'success');

            document.getElementById('walkinModal').style.display = 'none';
            clearWalkinForm();
        }

        function saveCompanyFromModal() {
            const patient = document.getElementById('modal_company_patient').value.trim();
            const company = document.getElementById('modal_company_name').value.trim();
            const package = document.getElementById('modal_company_package').value.trim();
            const amount = Number(document.getElementById('modal_company_amount').value || 0);

            if (!patient || !company || !package || amount <= 0) {
                showToast('Please fill all fields with valid values', 'error');
                return;
            }

            const newCompany = {
                number: state.companies.length + 1,
                patient_name: patient,
                company: company,
                package: package,
                amount: amount,
                created_by: getCurrentUser().username
            };

            state.companies.push(newCompany);
            saveAll();
            renderCompanies();
            renderAppointmentHistory();
            updateTopStats();
            updateReportTotals();
            showToast('Company appointment saved to history', 'success');

            document.getElementById('companyModal').style.display = 'none';
            clearCompanyForm();
        }

        function clearWalkinForm() {
            document.getElementById('modal_walkin_patient').value = '';
            document.getElementById('modal_walkin_procedures').value = '';
            document.getElementById('modal_walkin_amount').value = '';
            document.getElementById('modal_walkin_date').value = new Date().toISOString().slice(0, 10);
            document.getElementById('modal_walkin_contact').value = '';
            document.getElementById('modal_walkin_doctor').value = '';
        }

        function clearCompanyForm() {
            document.getElementById('modal_company_patient').value = '';
            document.getElementById('modal_company_name').value = '';
            document.getElementById('modal_company_package').value = '';
            document.getElementById('modal_company_amount').value = '';
        }

        // ===== ADD ADMIN FUNCTION =====
        function addAdmin() {
            document.getElementById('addAdminModal').style.display = 'flex';
        }

        function saveAdminFromModal() {
            const firstName = document.getElementById('adminFirstName').value.trim();
            const lastName = document.getElementById('adminLastName').value.trim();
            const phone = document.getElementById('adminPhone').value.trim();
            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value;

            if (!firstName || !lastName || !phone || !username || !password) {
                showToast('Please fill all fields', 'error');
                return;
            }

            const administrators = JSON.parse(localStorage.getItem(ADMIN_STORAGE)) || [];

            if (administrators.some(admin => admin.username === username)) {
                showToast('Username already exists', 'error');
                return;
            }

            const newAdmin = {
                firstName,
                lastName,
                phone,
                username,
                password,
                dateAdded: new Date().toLocaleDateString()
            };

            administrators.push(newAdmin);
            localStorage.setItem(ADMIN_STORAGE, JSON.stringify(administrators));

            renderAdministrators();
            updateTopStats();
            showToast('Administrator added successfully', 'success');

            document.getElementById('addAdminModal').style.display = 'none';
            clearAdminForm();
        }

        function clearAdminForm() {
            document.getElementById('adminFirstName').value = '';
            document.getElementById('adminLastName').value = '';
            document.getElementById('adminPhone').value = '';
            document.getElementById('adminUsername').value = '';
            document.getElementById('adminPassword').value = '';
        }

        // ===== RENDER FUNCTIONS =====
        function renderUtensils() {
            const tbody = document.getElementById('utensilTableBody');
            tbody.innerHTML = '';

            if (state.utensils.length === 0) {
                tbody.innerHTML = `
            <tr><td colspan="4" class="empty-state">
                <i class="fas fa-utensils"></i><h3>No Utensils</h3><p>Add utensils using the form above</p>
            </td></tr>`;
                return;
            }

            state.utensils.forEach((e, i) => {
                const statusInfo = getUtensilStatus(e.qty, e.threshold || 5);
                const tr = document.createElement('tr');
                tr.innerHTML = `
            <td>${escapeHtml(e.name)}</td>
            <td>${escapeHtml(e.qty)}</td>
            <td><span class="status-badge ${statusInfo.class}"><i class="${statusInfo.icon}"></i> ${statusInfo.status}</span></td>
            <td>
                <button class="btn-edit" data-idx="${i}" data-type="edit-utensil"><i class="fas fa-edit"></i> Edit</button>
                <button class="btn-danger" data-idx="${i}" data-type="del-utensil"><i class="fas fa-trash"></i> Remove</button>
            </td>`;
                tbody.appendChild(tr);
            });
        }

        function getUtensilStatus(qty, threshold = 5) {
            if (qty === 0) return { status: 'Critical', class: 'status-critical', icon: 'fas fa-exclamation-triangle' };
            if (qty <= Math.floor(threshold * 0.25)) return { status: 'Very Low', class: 'status-critical', icon: 'fas fa-exclamation-triangle' };
            if (qty <= Math.floor(threshold * 0.5)) return { status: 'Low', class: 'status-low', icon: 'fas fa-exclamation-circle' };
            if (qty <= threshold) return { status: 'Moderate', class: 'status-moderate', icon: 'fas fa-info-circle' };
            if (qty <= threshold * 2) return { status: 'Well Stocked', class: 'status-well', icon: 'fas fa-check-circle' };
            return { status: 'Excellent', class: 'status-excellent', icon: 'fas fa-star' };
        }

        function renderSupplies() {
            const tbody = document.getElementById('supplyTableBody');
            tbody.innerHTML = '';

            if (state.supplies.length === 0) {
                tbody.innerHTML = `
            <tr><td colspan="4" class="empty-state">
                <i class="fas fa-boxes"></i><h3>No Medical Supplies</h3><p>Add supplies using the form above</p>
            </td></tr>`;
                return;
            }

            state.supplies.forEach((u, i) => {
                const statusInfo = getSupplyStatus(u.qty, u.threshold || 10);
                const tr = document.createElement('tr');
                tr.innerHTML = `
            <td>${escapeHtml(u.name)}</td>
            <td>${escapeHtml(u.qty)}</td>
            <td><span class="status-badge ${statusInfo.class}"><i class="${statusInfo.icon}"></i> ${statusInfo.status}</span></td>
            <td>
                <button class="btn-edit" data-idx="${i}" data-type="edit-supply"><i class="fas fa-edit"></i> Edit</button>
                <button class="btn-danger" data-idx="${i}" data-type="del-supply"><i class="fas fa-trash"></i> Remove</button>
            </td>`;
                tbody.appendChild(tr);
            });
        }

        function getSupplyStatus(qty, threshold = 10) {
            if (qty === 0) return { status: 'Critical', class: 'status-critical', icon: 'fas fa-exclamation-triangle' };
            if (qty < Math.floor(threshold * 0.25)) return { status: 'Very Low', class: 'status-critical', icon: 'fas fa-exclamation-triangle' };
            if (qty < Math.floor(threshold * 0.5)) return { status: 'Low', class: 'status-low', icon: 'fas fa-exclamation-circle' };
            if (qty < threshold) return { status: 'Moderate', class: 'status-moderate', icon: 'fas fa-info-circle' };
            if (qty < threshold * 2) return { status: 'Well Stocked', class: 'status-well', icon: 'fas fa-check-circle' };
            return { status: 'Excellent', class: 'status-excellent', icon: 'fas fa-star' };
        }

        function renderAppointments() {
            const tbody = document.getElementById('apptTableBody');
            tbody.innerHTML = '';

            if (state.appointments.length === 0) {
                tbody.innerHTML = `
            <tr><td colspan="5" class="empty-state">
                <i class="fas fa-calendar-alt"></i><h3>No Appointments</h3><p>Add appointments using the form above</p>
            </td></tr>`;
                return;
            }

            state.appointments.forEach((a, i) => {
                const statusClass = a.status === 'approved' ? 'status-approved' : 'status-pending';
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${i + 1}</td><td>${escapeHtml(a.patient)}</td><td>${escapeHtml(a.date)}</td>
            <td><span class="status-badge ${statusClass}">${a.status}</span></td>
            <td>${a.status !== 'approved' ? `<button class="btn-primary" data-idx="${i}" data-type="approve-appt"><i class="fas fa-check"></i> Approve</button>` : ''} 
                <button class="btn-danger" data-idx="${i}" data-type="del-appt"><i class="fas fa-times"></i> Cancel</button></td>`;
                tbody.appendChild(tr);
            });
        }

        function renderAdministrators() {
            const tbody = document.getElementById('adminTableBody');
            tbody.innerHTML = '';

            const administrators = JSON.parse(localStorage.getItem(ADMIN_STORAGE)) || [];

            if (administrators.length === 0) {
                tbody.innerHTML = `
            <tr><td colspan="7" class="empty-state">
                <i class="fas fa-user-shield"></i><h3>No Administrators</h3><p>Add administrators using the button above</p>
            </td></tr>`;
                return;
            }

            administrators.forEach((a, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
            <td>${i + 1}</td>
            <td>${escapeHtml(a.firstName)}</td>
            <td>${escapeHtml(a.lastName)}</td>
            <td>${escapeHtml(a.phone)}</td>
            <td>${escapeHtml(a.username)}</td>
            <td>${escapeHtml(a.dateAdded || new Date().toLocaleDateString())}</td>
            <td><button class="btn-danger remove-admin-btn" data-idx="${i}" data-type="remove-admin"><i class="fas fa-trash"></i> Remove</button></td>`;
                tbody.appendChild(tr);
            });
        }

        function renderSales() {
            const tbody = document.getElementById('salesTableBody');
            tbody.innerHTML = '';

            if (state.sales.length === 0) {
                tbody.innerHTML = `
            <tr><td colspan="5" class="empty-state">
                <i class="fas fa-money-bill-wave"></i><h3>No Sales Records</h3><p>Record sales using the form above</p>
            </td></tr>`;
                return;
            }

            state.sales.forEach((s, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${i + 1}</td><td>${escapeHtml(s.note)}</td><td>â‚±${Number(s.amount).toFixed(2)}</td>
            <td>${(new Date(s.date)).toISOString().slice(0, 10)}</td>
            <td><button class="btn-danger" data-idx="${i}" data-type="del-sale"><i class="fas fa-trash"></i> Void</button></td>`;
                tbody.appendChild(tr);
            });
        }

        function renderWalkins() {
            const tbody = document.getElementById('walkinTableBody');
            tbody.innerHTML = '';

            if (state.walkins.length === 0) {
                tbody.innerHTML = `
            <tr><td colspan="8" class="empty-state">
                <i class="fas fa-walking"></i><h3>No Walk-In Appointments</h3><p>Walk-in appointments will appear here</p>
            </td></tr>`;
                return;
            }

            state.walkins.forEach((w, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${w.number}</td><td>${escapeHtml(w.patient_name)}</td><td>${escapeHtml(w.procedures.join(', '))}</td>
            <td>â‚±${Number(w.amount).toFixed(2)}</td><td style="max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(w.date)}</td><td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(w.contact)}</td>
            <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(w.doctor_name)}</td>
            <td><button class="btn-danger" data-idx="${i}" data-type="del-walkin"><i class="fas fa-trash"></i> Remove</button></td>`;
                tbody.appendChild(tr);
            });
            updateWalkinTotal();
        }

        function renderCompanies() {
            const tbody = document.getElementById('companyTableBody');
            tbody.innerHTML = '';

            if (state.companies.length === 0) {
                tbody.innerHTML = `
            <tr><td colspan="6" class="empty-state">
                <i class="fas fa-building"></i><h3>No Company Appointments</h3><p>Company appointments will appear here</p>
            </td></tr>`;
                return;
            }

            state.companies.forEach((c, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${c.number}</td><td>${escapeHtml(c.patient_name)}</td><td>${escapeHtml(c.company)}</td>
            <td>${escapeHtml(c.package)}</td><td>â‚±${Number(c.amount).toFixed(2)}</td>
            <td><button class="btn-danger" data-idx="${i}" data-type="del-company"><i class="fas fa-trash"></i> Remove</button></td>`;
                tbody.appendChild(tr);
            });
            updateCompanyTotal();
        }

        function renderReports() {
            const tbody = document.getElementById('reportsTableBody');
            tbody.innerHTML = '';

            if (state.reports.length === 0) {
                tbody.innerHTML = `
            <tr><td colspan="6" class="empty-state">
                <i class="fas fa-file-alt"></i><h3>No Reports Generated</h3><p>Generate reports using the button above</p>
            </td></tr>`;
                return;
            }

            state.reports.forEach((r, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
            <td>${r.id}</td>
            <td>${escapeHtml(r.date)}</td>
            <td>â‚±${Number(r.walkinTotal).toFixed(2)}</td>
            <td>â‚±${Number(r.companyTotal).toFixed(2)}</td>
            <td>â‚±${Number(r.combinedTotal).toFixed(2)}</td>
            <td>
                <button class="btn-primary" data-idx="${i}" data-type="view-report"><i class="fas fa-eye"></i> View</button>
                <button class="btn-success" data-idx="${i}" data-type="print-report"><i class="fas fa-print"></i> Print</button>
                <button class="btn-danger" data-idx="${i}" data-type="del-report"><i class="fas fa-trash"></i> Delete</button>
            </td>`;
                tbody.appendChild(tr);
            });
        }

        function renderAppointmentHistory() {
            const tbody = document.getElementById('appointmentHistoryBody');
            tbody.innerHTML = '';

            const allAppointments = [
                ...state.walkins.map(w => ({ ...w, type: 'Walk-In' })),
                ...state.companies.map(c => ({ ...c, type: 'Company' }))
            ].sort((a, b) => new Date(b.date || new Date()) - new Date(a.date || new Date()));

            if (allAppointments.length === 0) {
                tbody.innerHTML = `
            <tr><td colspan="9" class="empty-state">
                <i class="fas fa-history"></i><h3>No Appointment History</h3><p>Appointments will appear here when saved from Walk-In or Company sections</p>
            </td></tr>`;
                return;
            }

            allAppointments.forEach((appointment, i) => {
                const tr = document.createElement('tr');
                let details = '';

                if (appointment.type === 'Walk-In') {
                    details = `Procedures: ${appointment.procedures.join(', ')}`;
                } else {
                    details = `Company: ${appointment.company}, Package: ${appointment.package}`;
                }

                tr.innerHTML = `
            <td><span class="status-badge ${appointment.type === 'Walk-In' ? 'status-well' : 'status-excellent'}">${appointment.type}</span></td>
            <td>${appointment.number}</td>
            <td>${escapeHtml(appointment.patient_name)}</td>
            <td>${escapeHtml(details)}</td>
            <td>â‚±${Number(appointment.amount).toFixed(2)}</td>
            <td style="max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(appointment.date)}</td>
            <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${appointment.type === 'Walk-In' ? escapeHtml(appointment.contact || 'N/A') : 'N/A'}</td>
            <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${appointment.type === 'Walk-In' ? escapeHtml(appointment.doctor_name || 'N/A') : 'N/A'}</td>
            <td>
                <button class="btn-danger" data-idx="${i}" data-type="${appointment.type === 'Walk-In' ? 'del-walkin-history' : 'del-company-history'}"><i class="fas fa-trash"></i> Delete</button>
            </td>`;
                tbody.appendChild(tr);
            });
        }

        // ===== AUTOMATIC TOTAL CALCULATION =====
        function updateReportTotals() {
            const walkinTotal = state.walkins.reduce((sum, w) => sum + w.amount, 0);
            const companyTotal = state.companies.reduce((sum, c) => sum + c.amount, 0);
            const combinedTotal = walkinTotal + companyTotal;

            document.getElementById('reportWalkinTotal').textContent = `â‚±${walkinTotal.toFixed(2)}`;
            document.getElementById('reportCompanyTotal').textContent = `â‚±${companyTotal.toFixed(2)}`;
            document.getElementById('reportCombinedTotal').textContent = `â‚±${combinedTotal.toFixed(2)}`;
            document.getElementById('reportTotalCount').textContent = state.reports.length;
        }

        // ===== STATS =====
        function updateTopStats() {
            document.getElementById('statUtensils').textContent = state.utensils.length;
            document.getElementById('statPendingAppt').textContent = state.appointments.filter(a => a.status === 'pending').length;

            const administrators = JSON.parse(localStorage.getItem(ADMIN_STORAGE)) || [];
            document.getElementById('statAdmins').textContent = administrators.length;

            const daily = computeDailyTotal();
            document.getElementById('statSalesDay').textContent = `â‚±${daily.toFixed(2)}`;
            document.getElementById('dailyTotal').textContent = `â‚±${daily.toFixed(2)}`;
            document.getElementById('monthlyTotal').textContent = `â‚±${computeMonthlyTotal().toFixed(2)}`;
        }

        function updateWalkinTotal() {
            const total = state.walkins.reduce((sum, walkin) => sum + walkin.amount, 0);
            const totalAppt = state.walkins.length;
            document.getElementById('walkinTotalAmount').textContent = `â‚±${total.toFixed(2)}`;
            document.getElementById('walkinTotalAppt').textContent = totalAppt;
        }

        function updateCompanyTotal() {
            const total = state.companies.reduce((sum, company) => sum + company.amount, 0);
            const totalAppt = state.companies.length;
            document.getElementById('companyTotalAmount').textContent = `â‚±${total.toFixed(2)}`;
            document.getElementById('companyTotalAppt').textContent = totalAppt;
        }

        function computeDailyTotal(dStr) {
            const day = dStr || new Date().toISOString().slice(0, 10);
            return state.sales.reduce((acc, s) => {
                const sd = (new Date(s.date)).toISOString().slice(0, 10);
                return sd === day ? acc + Number(s.amount || 0) : acc;
            }, 0);
        }

        function computeMonthlyTotal(monthStr) {
            const mon = monthStr || new Date().toISOString().slice(0, 7);
            return state.sales.reduce((acc, s) => {
                const m = (new Date(s.date)).toISOString().slice(0, 7);
                return m === mon ? acc + Number(s.amount || 0) : acc;
            }, 0);
        }

        // ===== CHARTS =====
        function buildChart() {
            const ctx = document.getElementById('salesChart').getContext('2d');
            const labels = []; const data = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                labels.push(d.toLocaleDateString(undefined, { weekday: 'short' }));
                data.push(computeDailyTotal(d.toISOString().slice(0, 10)));
            }
            salesChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{ label: 'Sales', data, fill: true, backgroundColor: 'rgba(255,180,60,0.12)', borderColor: 'rgba(255,150,30,0.98)', tension: 0.36, pointRadius: 4, borderWidth: 3 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { color: 'rgba(2,6,23,0.04)' } } }, animation: { duration: 1000, easing: 'easeOutQuart' } }
            });
        }

        function refreshChart() {
            if (!salesChart) return;
            const data = []; for (let i = 6; i >= 0; i--) { const d = new Date(); d.setDate(d.getDate() - i); data.push(computeDailyTotal(d.toISOString().slice(0, 10))); }
            salesChart.data.datasets[0].data = data;
            salesChart.update();
        }

        // ===== PROCEDURE-UTILITY DEDUCTION =====
        function deductSuppliesForProcedures(procedures) {
            let deductedItems = [];

            procedures.forEach(procedure => {
                const requiredSupplies = procedureUtilityMapping[procedure] || [];

                requiredSupplies.forEach(supplyName => {
                    const supplyIndex = state.supplies.findIndex(u => u.name.toLowerCase() === supplyName.toLowerCase());

                    if (supplyIndex !== -1) {
                        if (state.supplies[supplyIndex].qty > 0) {
                            state.supplies[supplyIndex].qty -= 1;
                            deductedItems.push({
                                name: supplyName,
                                previousQty: state.supplies[supplyIndex].qty + 1,
                                newQty: state.supplies[supplyIndex].qty
                            });
                        }
                    } else {
                        state.supplies.push({
                            name: supplyName,
                            qty: 0,
                            threshold: 10
                        });
                        deductedItems.push({
                            name: supplyName,
                            previousQty: 0,
                            newQty: 0,
                            note: 'Item was not in inventory'
                        });
                    }
                });
            });

            if (deductedItems.length > 0) {
                saveAll();
                renderSupplies();
                updateTopStats();

                let deductionMessage = 'Medical supplies deducted for procedures: ';
                deductedItems.forEach(item => {
                    deductionMessage += `${item.name} (${item.previousQty} â†’ ${item.newQty}), `;
                });
                deductionMessage = deductionMessage.slice(0, -2);

                showToast(deductionMessage, 'success');
            }

            return deductedItems;
        }

        // ===== REPORT GENERATION =====
        function generateTotalReport() {
            const walkinTotal = state.walkins.reduce((sum, w) => sum + w.amount, 0);
            const companyTotal = state.companies.reduce((sum, c) => sum + c.amount, 0);
            const combinedTotal = walkinTotal + companyTotal;

            const report = {
                id: 'TOTAL-' + Date.now(),
                date: new Date().toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }),
                walkinTotal: walkinTotal,
                companyTotal: companyTotal,
                combinedTotal: combinedTotal,
                walkinCount: state.walkins.length,
                companyCount: state.companies.length,
                walkinDetails: state.walkins,
                companyDetails: state.companies,
                generatedBy: getCurrentUser().firstName
            };

            return report;
        }

        function generateCombinedReport() {
            const walkinTotal = state.walkins.reduce((sum, w) => sum + w.amount, 0);
            const companyTotal = state.companies.reduce((sum, c) => sum + c.amount, 0);
            const combinedTotal = walkinTotal + companyTotal;

            const report = {
                id: 'RPT-' + Date.now(),
                date: new Date().toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }),
                walkinTotal: walkinTotal,
                companyTotal: companyTotal,
                combinedTotal: combinedTotal,
                walkinCount: state.walkins.length,
                companyCount: state.companies.length,
                walkinDetails: state.walkins,
                companyDetails: state.companies,
                generatedBy: getCurrentUser().firstName
            };

            state.reports.unshift(report);
            saveAll();
            renderReports();

            showToast('Combined report generated successfully!', 'success');
            return report;
        }

        function generateDetailedReport() {
            const walkinTotal = state.walkins.reduce((sum, w) => sum + w.amount, 0);
            const companyTotal = state.companies.reduce((sum, c) => sum + c.amount, 0);
            const combinedTotal = walkinTotal + companyTotal;

            const report = {
                id: 'DET-' + Date.now(),
                date: new Date().toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }),
                walkinTotal: walkinTotal,
                companyTotal: companyTotal,
                combinedTotal: combinedTotal,
                walkinCount: state.walkins.length,
                companyCount: state.companies.length,
                walkinDetails: state.walkins,
                companyDetails: state.companies,
                generatedBy: getCurrentUser().firstName
            };

            return report;
        }

        function previewReport(report) {
            const previewContent = document.getElementById('previewContent');

            let content = `
        <div style="margin-bottom: 20px;">
            <h3 style="color: #333; border-bottom: 1px solid #ddd; padding-bottom: 5px;">Summary</h3>
            <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                <tr>
                    <td style="padding: 8px; border: 1px solid #ddd;"><strong>Walk-In Revenue:</strong></td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">â‚±${report.walkinTotal.toFixed(2)}</td>
                </tr>
                <tr>
                    <td style="padding: 8px; border: 1px solid #ddd;"><strong>Company Revenue:</strong></td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">â‚±${report.companyTotal.toFixed(2)}</td>
                </tr>
                <tr style="background-color: #f9f9f9;">
                    <td style="padding: 8px; border: 1px solid #ddd;"><strong>Total Revenue:</strong></td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right; font-weight: bold;">â‚±${report.combinedTotal.toFixed(2)}</td>
                </tr>
                <tr>
                    <td style="padding: 8px; border: 1px solid #ddd;"><strong>Generated by:</strong></td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${report.generatedBy || getCurrentUser().firstName}</td>
                </tr>
            </table>
        </div>
    `;

            if (report.walkinDetails && report.walkinDetails.length > 0) {
                content += `
            <div style="margin-bottom: 20px;">
                <h3 style="color: #333; border-bottom: 1px solid #ddd; padding-bottom: 5px;">Walk-In Appointments (${report.walkinCount})</h3>
                <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                    <thead>
                        <tr style="background-color: #f5f5f5;">
                            <th style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">No.</th>
                            <th style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Patient</th>
                            <th style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Procedures</th>
                            <th style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Amount</th>
                            <th style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Date</th>
                            <th style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Contact</th>
                            <th style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Doctor</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

                report.walkinDetails.forEach(walkin => {
                    content += `
                <tr>
                    <td style="padding: 8px; border: 1px solid #ddd;">${walkin.number}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(walkin.patient_name)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(walkin.procedures.join(', '))}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">â‚±${walkin.amount.toFixed(2)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(walkin.date)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(walkin.contact)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(walkin.doctor_name)}</td>
                </tr>
            `;
                });

                content += `</tbody></table></div>`;
            }

            if (report.companyDetails && report.companyDetails.length > 0) {
                content += `
            <div style="margin-bottom: 20px;">
                <h3 style="color: #333; border-bottom: 1px solid #ddd; padding-bottom: 5px;">Company Appointments (${report.companyCount})</h3>
                <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                    <thead>
                        <tr style="background-color: #f5f5f5;">
                            <th style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">No.</th>
                            <th style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Patient</th>
                            <th style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Company</th>
                            <th style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Package</th>
                            <th style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

                report.companyDetails.forEach(company => {
                    content += `
                <tr>
                    <td style="padding: 8px; border: 1px solid #ddd;">${company.number}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(company.patient_name)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(company.company)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(company.package)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">â‚±${company.amount.toFixed(2)}</td>
                </tr>
            `;
                });

                content += `</tbody></table></div>`;
            }

            previewContent.innerHTML = content;
            document.getElementById('previewModal').style.display = 'flex';
        }

        // ===== PDF GENERATION - STANDARD A4/LETTER SIZE =====
        function printReport(report) {
            const printSection = document.getElementById('printSection');
            const reportTitle = document.getElementById('printReportTitle');
            const reportDate = document.getElementById('printReportDate');
            const reportUser = document.getElementById('printReportUser');
            const reportContent = document.getElementById('printReportContent');

            reportTitle.textContent = 'Financial Report - ' + report.id;
            reportDate.textContent = 'Generated on: ' + report.date;
            reportUser.textContent = 'Generated by: ' + (report.generatedBy || getCurrentUser().firstName);

            let content = `
        <div style="margin-bottom: 15px;">
            <h3 style="color: #333; border-bottom: 2px solid #ddd; padding-bottom: 8px; font-size: 20px;">Summary</h3>
            <table style="width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 16px;">
                <tr>
                    <td style="padding: 10px; border: 2px solid #ddd; font-weight: bold;">Walk-In Revenue:</td>
                    <td style="padding: 10px; border: 2px solid #ddd; text-align: right; font-weight: bold;">â‚±${report.walkinTotal.toFixed(2)}</td>
                </tr>
                <tr>
                    <td style="padding: 10px; border: 2px solid #ddd; font-weight: bold;">Company Revenue:</td>
                    <td style="padding: 10px; border: 2px solid #ddd; text-align: right; font-weight: bold;">â‚±${report.companyTotal.toFixed(2)}</td>
                </tr>
                <tr style="background-color: #f9f9f9;">
                    <td style="padding: 10px; border: 2px solid #ddd; font-weight: bold; font-size: 18px;">Total Revenue:</td>
                    <td style="padding: 10px; border: 2px solid #ddd; text-align: right; font-weight: bold; font-size: 18px; color: #16a34a;">â‚±${report.combinedTotal.toFixed(2)}</td>
                </tr>
            </table>
        </div>
    `;

            if (report.walkinDetails && report.walkinDetails.length > 0) {
                content += `
            <div style="margin-bottom: 15px;">
                <h3 style="color: #333; border-bottom: 2px solid #ddd; padding-bottom: 8px; font-size: 20px;">Walk-In Appointments (${report.walkinCount})</h3>
                <table style="width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 14px;">
                    <thead>
                        <tr style="background-color: #f5f5f5;">
                            <th style="padding: 10px; border: 2px solid #ddd; font-weight: bold;">No.</th>
                            <th style="padding: 10px; border: 2px solid #ddd; font-weight: bold;">Patient</th>
                            <th style="padding: 10px; border: 2px solid #ddd; font-weight: bold;">Procedures</th>
                            <th style="padding: 10px; border: 2px solid #ddd; font-weight: bold;">Amount</th>
                            <th style="padding: 10px; border: 2px solid #ddd; font-weight: bold;">Date</th>
                            <th style="padding: 10px; border: 2px solid #ddd; font-weight: bold;">Contact</th>
                            <th style="padding: 10px; border: 2px solid #ddd; font-weight: bold;">Doctor</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

                report.walkinDetails.forEach(walkin => {
                    content += `
                <tr>
                    <td style="padding: 8px; border: 1px solid #ddd;">${walkin.number}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(walkin.patient_name)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(walkin.procedures.join(', '))}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">â‚±${walkin.amount.toFixed(2)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(walkin.date)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(walkin.contact)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(walkin.doctor_name)}</td>
                </tr>
            `;
                });

                content += `</tbody></table></div>`;
            }

            if (report.companyDetails && report.companyDetails.length > 0) {
                content += `
            <div style="margin-bottom: 15px;">
                <h3 style="color: #333; border-bottom: 2px solid #ddd; padding-bottom: 8px; font-size: 20px;">Company Appointments (${report.companyCount})</h3>
                <table style="width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 14px;">
                    <thead>
                        <tr style="background-color: #f5f5f5;">
                            <th style="padding: 10px; border: 2px solid #ddd; font-weight: bold;">No.</th>
                            <th style="padding: 10px; border: 2px solid #ddd; font-weight: bold;">Patient</th>
                            <th style="padding: 10px; border: 2px solid #ddd; font-weight: bold;">Company</th>
                            <th style="padding: 10px; border: 2px solid #ddd; font-weight: bold;">Package</th>
                            <th style="padding: 10px; border: 2px solid #ddd; font-weight: bold;">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

                report.companyDetails.forEach(company => {
                    content += `
                <tr>
                    <td style="padding: 8px; border: 1px solid #ddd;">${company.number}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(company.patient_name)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(company.company)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(company.package)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">â‚±${company.amount.toFixed(2)}</td>
                </tr>
            `;
                });

                content += `</tbody></table></div>`;
            }

            reportContent.innerHTML = content;

            printSection.style.display = 'block';

            const opt = {
                margin: 0.5,
                filename: `financial-report-${report.id}.pdf`,
                image: {
                    type: 'jpeg',
                    quality: 1.0
                },
                html2canvas: {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    letterRendering: true
                },
                jsPDF: {
                    unit: 'in',
                    format: 'letter',
                    orientation: 'portrait'
                },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };

            html2pdf().set(opt).from(printSection).save().then(() => {
                console.log('PDF generated successfully');
                showToast('PDF downloaded successfully!', 'success');
                printSection.style.display = 'none';
            }).catch(error => {
                console.error('PDF generation error:', error);
                showToast('Error generating PDF. Please try again.', 'error');
                printSection.style.display = 'none';

                setTimeout(() => {
                    window.print();
                }, 1000);
            });
        }

        // ===== UTENSILS EDITING FUNCTIONS =====
        function editUtensil(index) {
            const utensil = state.utensils[index];
            currentEditingUtensilIndex = index;

            document.getElementById('edit_utensil_name').value = utensil.name;
            document.getElementById('edit_utensil_qty').value = utensil.qty;
            document.getElementById('edit_utensil_notes').value = utensil.notes || '';
            document.getElementById('edit_utensil_category').value = utensil.category || 'kitchen';

            document.getElementById('editUtensilsModal').style.display = 'flex';
        }

        function saveEditedUtensil() {
            const name = document.getElementById('edit_utensil_name').value.trim();
            const qty = Number(document.getElementById('edit_utensil_qty').value || 0);
            const notes = document.getElementById('edit_utensil_notes').value.trim();
            const category = document.getElementById('edit_utensil_category').value;

            if (!name || qty < 0) {
                showToast('Please fill all fields with valid values', 'error');
                return;
            }

            state.utensils[currentEditingUtensilIndex] = {
                ...state.utensils[currentEditingUtensilIndex],
                name,
                qty,
                notes,
                category
            };

            saveAll();
            renderUtensils();
            updateTopStats();

            // Speak confirmation
            if (aiVoiceEnabled) {
                speakText(`Utensil ${name} has been successfully updated. New quantity is ${qty} units.`);
            }

            showToast('Utensil updated successfully', 'success');

            document.getElementById('editUtensilsModal').style.display = 'none';
            currentEditingUtensilIndex = null;
        }

        // ===== SUPPLIES EDITING - UPDATED (CATEGORY REMOVED) =====
        function editSupply(index) {
            const supply = state.supplies[index];
            currentEditingSupplyIndex = index;

            document.getElementById('edit_supply_name').value = supply.name;
            document.getElementById('edit_supply_qty').value = supply.qty;
            document.getElementById('edit_supply_threshold').value = supply.threshold || 10;

            document.getElementById('editSuppliesModal').style.display = 'flex';
        }

        function saveEditedSupply() {
            const name = document.getElementById('edit_supply_name').value.trim();
            const qty = Number(document.getElementById('edit_supply_qty').value || 0);
            const threshold = Number(document.getElementById('edit_supply_threshold').value || 10);

            if (!name || qty < 0) {
                showToast('Please fill all fields with valid values', 'error');
                return;
            }

            state.supplies[currentEditingSupplyIndex] = {
                ...state.supplies[currentEditingSupplyIndex],
                name,
                qty,
                threshold
            };

            saveAll();
            renderSupplies();
            updateTopStats();

            // Speak confirmation
            if (aiVoiceEnabled) {
                speakText(`Medical supply ${name} has been successfully updated. New quantity is ${qty} units. Threshold set to ${threshold}.`);
            }

            showToast('Medical supply updated successfully', 'success');

            document.getElementById('editSuppliesModal').style.display = 'none';
            currentEditingSupplyIndex = null;
        }

        // ===== CONFIRMATION MODAL =====
        function showAdminConfirmationModal(index) {
            deleteType = 'admin';
            deleteIndex = index;

            const administrators = JSON.parse(localStorage.getItem(ADMIN_STORAGE)) || [];
            const admin = administrators[index];

            document.getElementById('confirmationText').textContent = `Are you sure you want to delete administrator ${admin.firstName} ${admin.lastName}?`;
            document.getElementById('confirmationModal').style.display = 'flex';

            let seconds = 5;
            updateTimerDisplay(seconds);

            deleteTimer = setInterval(() => {
                seconds--;
                updateTimerDisplay(seconds);

                if (seconds <= 0) {
                    clearInterval(deleteTimer);
                    document.getElementById('confirmationModal').style.display = 'none';
                    showToast('Deletion cancelled. Admin was not deleted.', 'warning');
                }
            }, 1000);
        }

        function updateTimerDisplay(seconds) {
            document.getElementById('confirmationTimer').textContent = `This action will be completed in ${seconds} seconds...`;
        }

        function cancelDelete() {
            clearInterval(deleteTimer);
            document.getElementById('confirmationModal').style.display = 'none';
            deleteType = null;
            deleteIndex = null;
            showToast('Deletion cancelled', 'warning');
        }

        function performAdminDelete() {
            clearInterval(deleteTimer);

            const administrators = JSON.parse(localStorage.getItem(ADMIN_STORAGE)) || [];
            const deletedAdmin = administrators[deleteIndex];

            administrators.splice(deleteIndex, 1);
            localStorage.setItem(ADMIN_STORAGE, JSON.stringify(administrators));

            renderAdministrators();
            updateTopStats();
            showToast(`Administrator ${deletedAdmin.firstName} ${deletedAdmin.lastName} deleted successfully`, 'success');

            document.getElementById('confirmationModal').style.display = 'none';
            deleteType = null;
            deleteIndex = null;
        }

        // ===== ENHANCED REFRESH =====
        function enhancedRefresh() {
            loadStateFromStorage();
            renderAll();
            updateTopStats();
            if (salesChart) refreshChart();
            updateReportTotals();
            showToast('All data refreshed successfully', 'success');
        }

        // ===== SALES DATA CONSISTENCY =====
        function handleSalesVoid(index) {
            if (confirm('Are you sure you want to void this sale? This action cannot be undone.')) {
                state.sales.splice(index, 1);
                saveAll();
                renderSales();
                updateTopStats();
                refreshChart();
                showToast('Sale voided successfully', 'success');
            }
        }

        // ===== BIND ADMIN UI =====
        function bindAdminUI() {
            // Utensils
            document.getElementById('addUtensil').addEventListener('click', () => {
                const n = document.getElementById('utensil_name').value.trim();
                const q = Number(document.getElementById('utensil_qty').value || 0);
                if (!n || q <= 0) { showToast('Enter valid name & qty', 'error'); return; }
                state.utensils.push({ name: n, qty: q, notes: '', category: 'kitchen' });
                saveAll(); renderUtensils(); updateTopStats();

                // Speak confirmation
                if (aiVoiceEnabled) {
                    speakText(`Utensil ${n} added successfully. Quantity set to ${q} units.`);
                }

                showToast('Utensil added', 'success');
                document.getElementById('utensil_name').value = ''; document.getElementById('utensil_qty').value = '';
            });

            // Medical Supplies - UPDATED (category removed from new items)
            document.getElementById('addSupply').addEventListener('click', () => {
                const n = document.getElementById('supply_name').value.trim();
                const q = Number(document.getElementById('supply_qty').value || 0);
                if (!n || q < 0) { showToast('Enter valid item & qty', 'error'); return; }
                const ex = state.supplies.find(u => u.name.toLowerCase() === n.toLowerCase());
                if (ex) {
                    ex.qty = q;
                    // Speak confirmation
                    if (aiVoiceEnabled) {
                        speakText(`Medical supply ${n} updated. New quantity is ${q} units.`);
                    }
                    showToast('Medical supply updated', 'success');
                }
                else {
                    state.supplies.push({ name: n, qty: q, threshold: 10 });
                    // Speak confirmation
                    if (aiVoiceEnabled) {
                        speakText(`Medical supply ${n} added successfully. Quantity set to ${q} units.`);
                    }
                    showToast('Medical supply added', 'success');
                }
                saveAll(); renderSupplies(); updateTopStats();
                document.getElementById('supply_name').value = ''; document.getElementById('supply_qty').value = '';
            });

            // Appointments
            document.getElementById('addAppt').addEventListener('click', () => {
                const p = document.getElementById('appt_patient').value.trim();
                const d = document.getElementById('appt_date').value;
                if (!p || !d) { showToast('Enter patient & date', 'error'); return; }
                state.appointments.push({ patient: p, date: d, status: 'pending' });
                saveAll(); renderAppointments(); updateTopStats();

                // Speak confirmation
                if (aiVoiceEnabled) {
                    speakText(`Appointment for ${p} scheduled for ${d}. Status is pending.`);
                }

                showToast('Appointment added', 'success');
                document.getElementById('appt_patient').value = ''; document.getElementById('appt_date').value = '';
            });

            // Sales
            document.getElementById('recordSale').addEventListener('click', () => {
                const note = document.getElementById('sale_note').value.trim();
                const amount = Number(document.getElementById('sale_amount').value || 0);
                if (!note || amount <= 0) { showToast('Enter service & positive amount', 'error'); return; }
                state.sales.push({ note, amount, date: new Date().toISOString() });
                saveAll(); renderSales(); updateTopStats(); refreshChart();

                // Speak confirmation
                if (aiVoiceEnabled) {
                    speakText(`Sale recorded for ${note}. Amount is ${amount} pesos.`);
                }

                showToast('Sale recorded', 'success');
                document.getElementById('sale_note').value = ''; document.getElementById('sale_amount').value = '';
            });

            // Add Admin button
            document.getElementById('addAdminBtn').addEventListener('click', addAdmin);

            // Save Admin from modal
            document.getElementById('saveAdmin').addEventListener('click', saveAdminFromModal);
            document.getElementById('cancelAddAdmin').addEventListener('click', () => {
                document.getElementById('addAdminModal').style.display = 'none';
                clearAdminForm();
            });

            // Save to History buttons
            document.getElementById('saveWalkinHistory').addEventListener('click', saveWalkinToHistory);
            document.getElementById('saveCompanyHistory').addEventListener('click', saveCompanyToHistory);

            // Modal buttons
            document.getElementById('saveWalkin').addEventListener('click', saveWalkinFromModal);
            document.getElementById('saveCompany').addEventListener('click', saveCompanyFromModal);

            // Edit Utensils buttons
            document.getElementById('saveEditUtensil').addEventListener('click', saveEditedUtensil);
            document.getElementById('cancelEditUtensil').addEventListener('click', () => {
                document.getElementById('editUtensilsModal').style.display = 'none';
                currentEditingUtensilIndex = null;
            });

            // Edit Supplies buttons
            document.getElementById('saveEditSupply').addEventListener('click', saveEditedSupply);
            document.getElementById('cancelEditSupply').addEventListener('click', () => {
                document.getElementById('editSuppliesModal').style.display = 'none';
                currentEditingSupplyIndex = null;
            });

            // Preview buttons
            document.getElementById('previewTotalReport').addEventListener('click', () => {
                const report = generateCombinedReport();
                previewReport(report);
            });

            document.getElementById('printFromPreview').addEventListener('click', () => {
                const report = state.reports[0];
                printReport(report);
                document.getElementById('previewModal').style.display = 'none';
            });

            document.getElementById('closePreview').addEventListener('click', () => {
                document.getElementById('previewModal').style.display = 'none';
            });

            // Close modals
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                });
            });

            document.getElementById('cancelWalkin').addEventListener('click', () => {
                document.getElementById('walkinModal').style.display = 'none';
                clearWalkinForm();
            });

            document.getElementById('cancelCompany').addEventListener('click', () => {
                document.getElementById('companyModal').style.display = 'none';
                clearCompanyForm();
            });

            // Reports - PRINT THE TOTAL
            document.getElementById('printTotalReport').addEventListener('click', () => {
                const report = generateTotalReport();
                printReport(report);
                showToast('Total report printed successfully!', 'success');
            });

            document.getElementById('printWalkinReport').addEventListener('click', () => {
                const report = generateDetailedReport();
                printReport(report);
            });

            // History
            document.getElementById('printHistoryReport').addEventListener('click', () => {
                const report = generateDetailedReport();
                printReport(report);
            });

            // Confirmation modal buttons
            document.getElementById('confirmDelete').addEventListener('click', performAdminDelete);
            document.getElementById('cancelDelete').addEventListener('click', cancelDelete);

            // Refresh buttons
            document.getElementById('refreshOverview').addEventListener('click', enhancedRefresh);
            document.getElementById('refreshUtensils').addEventListener('click', enhancedRefresh);
            document.getElementById('refreshSupplies').addEventListener('click', enhancedRefresh);
            document.getElementById('refreshAppointments').addEventListener('click', enhancedRefresh);
            document.getElementById('refreshAdministrators').addEventListener('click', enhancedRefresh);
            document.getElementById('refreshSales').addEventListener('click', enhancedRefresh);
            document.getElementById('refreshWalkins').addEventListener('click', enhancedRefresh);
            document.getElementById('refreshCompanies').addEventListener('click', enhancedRefresh);
            document.getElementById('refreshReports').addEventListener('click', enhancedRefresh);
            document.getElementById('refreshHistory').addEventListener('click', enhancedRefresh);

            // Enhanced logout
            document.getElementById('logoutBtn').addEventListener('click', enhancedLogout);

            // Delegation for deletes and actions
            document.addEventListener('click', (ev) => {
                const btn = ev.target.closest('button[data-type]');
                if (!btn) return;
                const type = btn.getAttribute('data-type');
                const idx = Number(btn.getAttribute('data-idx'));

                if (type === 'del-utensil') {
                    if (confirm('Are you sure you want to remove this utensil?')) {
                        const utensilName = state.utensils[idx].name;
                        state.utensils.splice(idx, 1);
                        saveAll();
                        renderUtensils();
                        updateTopStats();

                        // Speak confirmation
                        if (aiVoiceEnabled) {
                            speakText(`Utensil ${utensilName} removed from inventory.`);
                        }

                        showToast('Utensil removed', 'success');
                    }
                }
                else if (type === 'edit-utensil') {
                    editUtensil(idx);
                }
                else if (type === 'del-supply') {
                    if (confirm('Are you sure you want to remove this medical supply?')) {
                        const supplyName = state.supplies[idx].name;
                        state.supplies.splice(idx, 1);
                        saveAll();
                        renderSupplies();
                        updateTopStats();

                        // Speak confirmation
                        if (aiVoiceEnabled) {
                            speakText(`Medical supply ${supplyName} removed from inventory.`);
                        }

                        showToast('Medical supply removed', 'success');
                    }
                }
                else if (type === 'edit-supply') {
                    editSupply(idx);
                }
                else if (type === 'del-appt') {
                    if (confirm('Are you sure you want to cancel this appointment?')) {
                        const patientName = state.appointments[idx].patient;
                        state.appointments.splice(idx, 1);
                        saveAll();
                        renderAppointments();
                        updateTopStats();

                        // Speak confirmation
                        if (aiVoiceEnabled) {
                            speakText(`Appointment for ${patientName} cancelled.`);
                        }

                        showToast('Appointment cancelled', 'success');
                    }
                }
                else if (type === 'approve-appt') {
                    const patientName = state.appointments[idx].patient;
                    state.appointments[idx].status = 'approved';
                    saveAll();
                    renderAppointments();
                    updateTopStats();

                    // Speak confirmation
                    if (aiVoiceEnabled) {
                        speakText(`Appointment for ${patientName} approved.`);
                    }

                    showToast('Appointment approved', 'success');
                }
                else if (type === 'del-sale') {
                    handleSalesVoid(idx);
                }
                else if (type === 'del-walkin') {
                    if (confirm('Are you sure you want to remove this walk-in appointment?')) {
                        const patientName = state.walkins[idx].patient_name;
                        state.walkins.splice(idx, 1);
                        saveAll();
                        renderWalkins();
                        updateTopStats();
                        renderAppointmentHistory();
                        updateReportTotals();

                        // Speak confirmation
                        if (aiVoiceEnabled) {
                            speakText(`Walk-in appointment for ${patientName} removed.`);
                        }

                        showToast('Walk-In removed', 'success');
                    }
                }
                else if (type === 'del-company') {
                    if (confirm('Are you sure you want to remove this company appointment?')) {
                        const patientName = state.companies[idx].patient_name;
                        state.companies.splice(idx, 1);
                        saveAll();
                        renderCompanies();
                        updateTopStats();
                        renderAppointmentHistory();
                        updateReportTotals();

                        // Speak confirmation
                        if (aiVoiceEnabled) {
                            speakText(`Company appointment for ${patientName} removed.`);
                        }

                        showToast('Company removed', 'success');
                    }
                }
                else if (type === 'remove-admin') {
                    showAdminConfirmationModal(idx);
                }
                else if (type === 'view-report') {
                    const report = state.reports[idx];
                    showToast(`Viewing report ${report.id}`, 'success');
                    previewReport(report);
                }
                else if (type === 'print-report') {
                    const report = state.reports[idx];
                    printReport(report);
                }
                else if (type === 'del-report') {
                    if (confirm('Are you sure you want to delete this report?')) {
                        state.reports.splice(idx, 1);
                        saveAll();
                        renderReports();

                        // Speak confirmation
                        if (aiVoiceEnabled) {
                            speakText(`Report deleted successfully.`);
                        }

                        showToast('Report deleted successfully', 'success');
                    }
                }
                else if (type === 'del-walkin-history') {
                    if (confirm('Are you sure you want to delete this walk-in history?')) {
                        const patientName = state.walkins[idx].patient_name;
                        state.walkins.splice(idx, 1);
                        saveAll();
                        renderWalkins();
                        renderReports();
                        renderAppointmentHistory();
                        updateReportTotals();

                        // Speak confirmation
                        if (aiVoiceEnabled) {
                            speakText(`Walk-in history for ${patientName} deleted.`);
                        }

                        showToast('Walk-In history deleted', 'success');
                    }
                }
                else if (type === 'del-company-history') {
                    if (confirm('Are you sure you want to delete this company history?')) {
                        const patientName = state.companies[idx].patient_name;
                        state.companies.splice(idx, 1);
                        saveAll();
                        renderCompanies();
                        renderReports();
                        renderAppointmentHistory();
                        updateReportTotals();

                        // Speak confirmation
                        if (aiVoiceEnabled) {
                            speakText(`Company history for ${patientName} deleted.`);
                        }

                        showToast('Company history deleted', 'success');
                    }
                }
            });
        }

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function () {
            initAdminDashboard();
        });

        function showToast(msg, type = 'success', dur = 1400) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast ' + type;
            t.classList.add('show');
            t.style.opacity = '1';
            setTimeout(() => {
                t.style.opacity = '0';
                t.classList.remove('show');
            }, dur);
        }

        // Ensure chart updates on save
        (function wrapSave() {
            const orig = saveAll;
            saveAll = function () {
                orig();
                updateTopStats();
                refreshChart();
            };
        })();
    </script>
</body>

</html>