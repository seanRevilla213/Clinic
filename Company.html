<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <link rel="Shortcut Icon" type="image/png" href="stmikelogorig.png">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Company Appointments - St. Michael's Clinic Diagnostic
            Center</title>
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap"
            rel="stylesheet">
        <link rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <style>
        :root {
            --gold-1: #ffd66b;
            --gold-2: #ffb84d;
            --gold-3: #ff9d1a;
            --muted: #6b7280;
            --card-bg: #ffffff;
            --text-dark: #07121a;
            --panel-radius: 14px;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
            background: url('clinicbgg.png') center/cover no-repeat fixed;
            min-height: 100vh;
            color: var(--text-dark);
        }

        /* Navigation Styles */
        .top-nav {
            background-color: #f3f4f6;
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(2,6,23,0.1);
            border-bottom: 1px solid rgba(2,6,23,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .nav-brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-brand i {
            color: var(--gold-2);
        }
        
        .nav-links {
            display: flex;
            gap: 20px;
        }
        
        .nav-link {
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            color: var(--text-dark);
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover {
            background-color: rgba(255, 180, 60, 0.1);
        }
        
        .nav-link.active {
            background: linear-gradient(90deg, var(--gold-1), var(--gold-2));
            color: #111;
            font-weight: 600;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(90deg, var(--gold-1), var(--gold-2));
            display: flex;
            align-items: center;
            justify-content: center;
            color: #111;
            font-weight: bold;
        }
        
        .container {
            max-width: 800px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .header {
            background: var(--card-bg);
            border-radius: var(--panel-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(2,6,23,0.15);
            border: 1px solid rgba(2,6,23,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--text-dark);
        }
        
        .header-info {
            text-align: right;
        }
        
        .header-info .date {
            font-size: 14px;
            color: var(--muted);
        }
        
        .header-info .status {
            font-size: 16px;
            color: #16a34a;
            font-weight: 600;
        }
        
        .panel {
            background: var(--card-bg);
            border-radius: var(--panel-radius);
            padding: 30px;
            box-shadow: 0 10px 30px rgba(2,6,23,0.15);
            border: 1px solid rgba(2,6,23,0.08);
        }
        
        .panel h3 {
            margin: 0 0 20px 0;
            color: var(--text-dark);
            font-size: 1.3rem;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-dark);
            font-size: 14px;
        }
        
        .auto-number-display {
            background: linear-gradient(135deg, var(--gold-1), var(--gold-2));
            color: #111;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            text-align: center;
            border: 2px dashed var(--gold-3);
            box-shadow: 0 4px 12px rgba(255, 157, 26, 0.2);
        }
        
        .auto-number-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .auto-number-label span {
            font-size: 12px;
            color: var(--muted);
            font-weight: normal;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(2,6,23,0.1);
            background: #fff;
            color: var(--text-dark);
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--gold-2);
            box-shadow: 0 0 0 3px rgba(255, 180, 60, 0.1);
        }
        
        .phone-input-container {
            position: relative;
        }
        
        .phone-prefix {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--muted);
            font-weight: 500;
            pointer-events: none;
        }
        
        .phone-input {
            padding-left: 45px !important;
        }
        
        .phone-format-hint {
            font-size: 12px;
            color: var(--muted);
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .phone-format-hint.valid {
            color: #16a34a;
        }
        
        .phone-format-hint.invalid {
            color: #dc2626;
        }
        
        /* Procedures Styles */
        .custom-select-container {
            margin-bottom: 20px;
        }
        
        .custom-select {
            border: 1px solid rgba(2,6,23,0.1);
            border-radius: 8px;
            background-color: white;
            padding: 8px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            cursor: pointer;
            font-weight: 600;
            color: #1f2937;
            border-radius: 6px;
            margin-bottom: 6px;
            transition: all 0.3s ease;
        }
        
        .category-header:hover {
            background: linear-gradient(135deg, #e5e7eb, #d1d5db);
            transform: translateX(5px);
        }
        
        .category-options {
            display: none;
            padding-left: 20px;
        }
        
        .category-options.show {
            display: block;
        }
        
        .procedure-option {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            cursor: pointer;
            border-radius: 6px;
            margin: 2px 0;
            transition: all 0.2s ease;
        }
        
        .procedure-option:hover {
            background-color: #f3f4f6;
            transform: translateX(3px);
        }
        
        .procedure-option.selected {
            background-color: rgba(255, 200, 110, 0.3);
            border-left: 4px solid var(--gold-2);
        }
        
        .selected-procedures {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px dashed #d1d5db;
            min-height: 60px;
        }
        
        .procedure-badge {
            background: linear-gradient(135deg, var(--gold-1), var(--gold-2));
            color: #111;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .procedure-badge button {
            background: none;
            border: none;
            color: #dc2626;
            cursor: pointer;
            font-size: 0.875rem;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .procedure-badge button:hover {
            background: #dc2626;
            color: white;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, var(--gold-1), var(--gold-2));
            color: #111;
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 700;
            font-size: 16px;
            transition: transform 0.2s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
        }
        
        .btn-primary:disabled {
            background: #d1d5db;
            color: #6b7280;
            cursor: not-allowed;
            transform: none;
        }
        
        .toast {
            position: fixed;
            right: 26px;
            bottom: 26px;
            background: #fff;
            color: var(--text-dark);
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(2,6,23,0.15);
            opacity: 0;
            transform: translateY(10px);
            transition: all .32s ease;
            z-index: 99998;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #f3f4f6;
            color: var(--text-dark);
            padding: 10px 16px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            margin-bottom: 20px;
            transition: all 0.2s ease;
        }
        
        .back-btn:hover {
            background: #e5e7eb;
            transform: translateY(-2px);
        }

        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
            text-align: center;
            border-left: 4px solid #10b981;
        }

        .success-message.show {
            display: block;
        }
        
        .user-display {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 180, 60, 0.1);
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .top-nav {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            
            .nav-links {
                width: 100%;
                justify-content: center;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .form-group {
                min-width: 100%;
            }
            
            .container {
                padding: 10px;
            }
            
            .header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .header-info {
                text-align: center;
            }
        }
    </style>
    </head>
    <body>
        <!-- Top Navigation -->
        <nav class="top-nav">
            <div class="nav-brand">
                <img src="stmikelogorig.png" alt="Hospital Logo"
                    style="width: 40px; height: auto;">
                <span>St. Michael's Clinic</span>
            </div>

            <div class="nav-links">
                <a href="walkin.html" class="nav-link">Walk-In</a>
                <a href="Company.html" class="nav-link active">Company</a>
                <a href="index.html" class="nav-link">Webpage</a>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container">
            <div class="header">
                <div>
                    <h1>Company Appointment</h1>
                    <div
                        style="font-size: 14px; color: var(--muted); margin-top: 5px;">
                        Fill out the form below to add a new company appointment
                    </div>
                </div>
                <div class="header-info">
                    <div class="date">Today: <span id="todayDate"></span></div>
                    <div class="status">System Status: <span>‚óè
                            Operational</span></div>
                    <div id="realTime"
                        style="margin-top: 4px; font-size: 14px; color: var(--muted);"></div>
                </div>
            </div>

            <div class="panel">
                <h3>Company Appointment Details</h3>

                <!-- Automatic Appointment Number Display -->
                <div class="form-group">
                    <div class="auto-number-label">
                        <label for="appointmentNumber">Appointment
                            Number</label>
                        <span>Auto-generated</span>
                    </div>
                    <div class="auto-number-display"
                        id="appointmentNumberDisplay">
                        Loading...
                    </div>
                    <input type="hidden" id="appointmentNumber">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="companyContact">Contact Number *</label>
                        <div class="phone-input-container">
                            <span class="phone-prefix">+63</span>
                            <input id="companyContact"
                                placeholder="912 345 6789" type="tel"
                                class="phone-input" maxlength="13"
                                oninput="validatePhoneInput(this)"
                                onkeydown="preventTextInput(event)" />
                        </div>
                        <div class="phone-format-hint" id="phoneHint">
                            <i class="fas fa-info-circle"></i>
                            Format: +63 912 345 6789 (11 digits total)
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="companyPatientName">Patient Name *</label>
                        <input id="companyPatientName"
                            placeholder="Enter patient full name" type="text"
                            oninput="validateTextInput(this)" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="companyName">Company *</label>
                        <input id="companyName" placeholder="Enter company name"
                            type="text" oninput="validateTextInput(this)" />
                    </div>
                    <div class="form-group">
                        <label for="companyPackage">Package *</label>
                        <select id="companyPackage">
                            <option value>Select Package</option>
                            <option value="B5">B5 Package</option>
                            <option value="B2">B2 Package</option>
                            <option value="B3">B3 Package</option>
                            <option value="B4">B4 Package</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="companyAmount">Amount *</label>
                        <input id="companyAmount" placeholder="0.00" type="text"
                            oninput="validateAmountInput(this)"
                            onkeydown="preventTextInput(event, true)" />
                    </div>
                    <div class="form-group">
                        <label for="companyDate">Date *</label>
                        <input id="companyDate" type="date" />
                    </div>
                </div>

                <!-- Procedures Section -->
                <div class="form-group">
                    <label>Procedures *</label>
                    <div class="custom-select-container">
                        <div id="companyProcedures" class="custom-select">
                            <!-- Procedures will be populated by JavaScript -->
                        </div>
                    </div>
                    <div id="selectedProcedures" class="selected-procedures">
                        <div
                            style="color: var(--muted); font-size: 14px; text-align: center; width: 100%;">
                            No procedures selected yet
                        </div>
                    </div>
                </div>

                <button class="btn-primary" id="addCompanyAppointment"
                    style="width: 100%; margin-top: 20px;">
                    <i class="fas fa-plus-circle"></i> Add Company Appointment
                </button>

                <div class="success-message" id="successMessage">
                    <i class="fas fa-check-circle"></i> Company appointment
                    added successfully!
                </div>
            </div>
        </div>

        <div class="toast" id="toast"></div>

        <script>
        // State management - Sync with admin storage
        const ADMIN_STORAGE = 'stmike_admin_gold_v1';
        
        // Function to get company data from admin storage ONLY
        function getCompanyData() {
            try {
                const adminData = JSON.parse(localStorage.getItem(ADMIN_STORAGE + '::companies')) || [];
                console.log('Admin company data:', adminData);
                
                // Return only admin data with proper structure
                return adminData.map(item => {
                    return {
                        id: item.id || Math.random(),
                        number: item.number || 0,
                        patient_name: item.patient_name || '',
                        company: item.company || '',
                        package: item.package || '',
                        amount: item.amount || 0,
                        date: item.date || new Date().toISOString().slice(0,10),
                        contact: item.contact || '',
                        procedures: item.procedures || []
                    };
                });
            } catch (error) {
                console.error('Error loading company data:', error);
                return [];
            }
        }

        // Function to sync data with admin storage
        function syncWithAdmin(newCompany) {
            try {
                // Get existing data from admin storage only
                const existingData = getCompanyData();
                
                // Add the new company appointment with proper structure
                const companyForAdmin = {
                    id: newCompany.id,
                    number: newCompany.appointmentNumber,
                    patient_name: newCompany.patient_name,
                    company: newCompany.company,
                    package: newCompany.package,
                    amount: newCompany.amount,
                    date: newCompany.date,
                    contact: newCompany.contact,
                    procedures: newCompany.procedures
                };
                
                existingData.push(companyForAdmin);
                
                console.log('Saving company data to admin storage:', existingData);
                
                // Save to admin storage only
                localStorage.setItem(ADMIN_STORAGE + '::companies', JSON.stringify(existingData));
                
                console.log('Data saved successfully to admin storage');
            } catch (error) {
                console.error('Error saving company data:', error);
            }
        }

        // Function to get the next company number automatically
        function getNextCompanyNumber() {
            const existingData = getCompanyData();
            
            if (existingData.length === 0) {
                return 1; // Start from 1 if no data exists
            }
            
            // Get the highest number from existing company appointments
            const maxNumber = Math.max(...existingData.map(w => w.number));
            return maxNumber + 1;
        }

        // Function to update the auto-generated number display
        function updateAutoNumberDisplay() {
            const nextNumber = getNextCompanyNumber();
            const displayElement = document.getElementById('appointmentNumberDisplay');
            const hiddenInput = document.getElementById('appointmentNumber');
            
            displayElement.textContent = `COMPANY #${nextNumber}`;
            hiddenInput.value = nextNumber;
        }

        // Phone number validation functions for 11 digits
        function formatPhoneNumber(input) {
            // Remove all non-digit characters
            let numbers = input.replace(/\D/g, '');
            
            // Limit to 11 digits total (including +63)
            // User enters 11 digits, but we store as +63 + 11 digits = 14 characters total
            numbers = numbers.substring(0, 11);
            
            // Format as XXX XXX XXXX for 11-digit numbers
            if (numbers.length > 7) {
                return numbers.substring(0, 4) + ' ' + numbers.substring(4, 7) + ' ' + numbers.substring(7);
            } else if (numbers.length > 4) {
                return numbers.substring(0, 4) + ' ' + numbers.substring(4);
            } else {
                return numbers;
            }
        }

        function validatePhoneNumber(phone) {
            // Remove spaces and check if it's exactly 11 digits
            const numbers = phone.replace(/\s/g, '');
            return /^\d{11}$/.test(numbers);
        }

        function updatePhoneHint(phone) {
            const hint = document.getElementById('phoneHint');
            const numbers = phone.replace(/\s/g, '');
            const isValid = validatePhoneNumber(phone);
            
            if (phone.length === 0) {
                hint.innerHTML = '<i class="fas fa-info-circle"></i> Format: +63 9123 456 7890 (11 digits total)';
                hint.className = 'phone-format-hint';
            } else if (isValid) {
                hint.innerHTML = '<i class="fas fa-check-circle"></i> Valid 11-digit phone number';
                hint.className = 'phone-format-hint valid';
            } else {
                hint.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${11 - numbers.length} digits remaining (11 digits total)`;
                hint.className = 'phone-format-hint invalid';
            }
            
            return isValid;
        }

        // Input validation functions to prevent text manipulation
        function validatePhoneInput(input) {
            // Remove any non-digit characters
            let value = input.value.replace(/\D/g, '');
            
            // Format the phone number
            const formatted = formatPhoneNumber(value);
            input.value = formatted;
            
            // Update validation hint
            updatePhoneHint(formatted);
        }
        
        function validateTextInput(input) {
            // Remove any special characters that could be used for injection
            input.value = input.value.replace(/[<>]/g, '');
        }
        
        function validateAmountInput(input) {
            // Get current value and cursor position
            let value = input.value;
            const cursorPos = input.selectionStart;
            
            // Remove any non-digit and non-decimal characters except the first decimal point
            let newValue = '';
            let decimalCount = 0;
            
            for (let i = 0; i < value.length; i++) {
                const char = value[i];
                if (char >= '0' && char <= '9') {
                    newValue += char;
                } else if (char === '.' && decimalCount === 0) {
                    newValue += char;
                    decimalCount++;
                }
            }
            
            // Limit to 2 decimal places
            if (decimalCount > 0) {
                const parts = newValue.split('.');
                if (parts.length > 1 && parts[1].length > 2) {
                    newValue = parts[0] + '.' + parts[1].substring(0, 2);
                }
            }
            
            // Format with commas for thousands
            if (newValue) {
                const parts = newValue.split('.');
                parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                newValue = parts.join('.');
            }
            
            // Update the input value
            input.value = newValue;
            
            // Restore cursor position (approximate)
            setTimeout(() => {
                input.setSelectionRange(cursorPos, cursorPos);
            }, 0);
        }

        // Prevent text input in numeric fields
        function preventTextInput(event, isAmount = false) {
            if (isAmount) {
                // Allow numbers, decimal point, and control keys
                if (!((event.key >= '0' && event.key <= '9') || 
                      event.key === '.' || 
                      event.key === 'Backspace' || 
                      event.key === 'Delete' || 
                      event.key === 'ArrowLeft' || 
                      event.key === 'ArrowRight' || 
                      event.key === 'Tab')) {
                    event.preventDefault();
                }
            } else {
                // For phone number - only allow numbers and control keys
                if (!((event.key >= '0' && event.key <= '9') || 
                      event.key === 'Backspace' || 
                      event.key === 'Delete' || 
                      event.key === 'ArrowLeft' || 
                      event.key === 'ArrowRight' || 
                      event.key === 'Tab')) {
                    event.preventDefault();
                }
            }
        }

        // Package definitions with their procedures - UPDATED AS REQUESTED
        const packageDefinitions = {
            "B5": [
                "Complete Blood Count (CBC)",
                "Urinalysis",
                "Fecalysis",
                "Chest X-ray",
                "Physical Examination (PE)"
            ],
            "B2": [
                // B2 has no procedures - empty array
            ],
            "B3": [
                "Complete Blood Count (CBC)",
                "Urinalysis",
                "Fecalysis",
                "Chest X-ray",
                "Physical Examination (PE)"
            ],
            "B4": [
                "Complete Blood Count (CBC)",
                "Urinalysis",
                "Fecalysis",
                "Chest X-ray",
                "Physical Examination (PE)"
            ]
        };

        // Procedures initialization with complete list from the image plus packages
        function initProcedures() {
            const proceduresContainer = document.getElementById('companyProcedures');
            
            // Add PACKAGES category first
            const packagesHeader = document.createElement('div');
            packagesHeader.className = 'category-header';
            packagesHeader.dataset.category = 'PACKAGES';
            packagesHeader.innerHTML = `PACKAGES <i class="fas fa-chevron-down"></i>`;
            proceduresContainer.appendChild(packagesHeader);

            const packagesOptions = document.createElement('div');
            packagesOptions.className = 'category-options show'; // Show packages by default
            packagesOptions.dataset.category = 'PACKAGES';
            
            // Add package options
            for (const [packageName, procedures] of Object.entries(packageDefinitions)) {
                const packageOption = document.createElement('div');
                packageOption.className = 'procedure-option package-option';
                packageOption.dataset.value = `Package ${packageName}`;
                packageOption.dataset.package = packageName;
                
                if (packageName === "B2") {
                    packageOption.innerHTML = `
                        <strong>${packageName} Package</strong>
                        <small style="margin-left: 10px; color: var(--muted);">(No procedures - Custom selection only)</small>
                    `;
                } else {
                    packageOption.innerHTML = `
                        <strong>${packageName} Package</strong>
                        <small style="margin-left: 10px; color: var(--muted);">(${procedures.length} procedures)</small>
                    `;
                }
                packagesOptions.appendChild(packageOption);
            }
            
            proceduresContainer.appendChild(packagesOptions);

            const proceduresData = {
                "BLOOD CHEMISTRY": [
                    "Fasting Blood Sugar (FBS)",
                    "Random Blood Sugar (RSS)",
                    "Oral Glucose Challenge Test (OGCT)",
                    "Oral Glucose Tolerance Test (OGTT)",
                    "Blood Urea Nitrogen (BUN)",
                    "Creatinine",
                    "Blood Uric Acid (BUA)",
                    "Cholesterol",
                    "Triglycerides",
                    "Lipid Profile",
                    "HDL Cholesterol",
                    "LDL Cholesterol", 
                    "VLDL Cholesterol",
                    "Total Bilirubin",
                    "Direct Bilirubin",
                    "Indirect Bilirubin",
                    "Total Protein",
                    "Albumin",
                    "Total Protein Albumin Globulin (TPAG)",
                    "Glycated Hemoglobin (HbA1c) with machine print out & graph"
                ],
                
                "ENZYMES": [
                    "Alanine Aminotransferase (SGPT/ALT)",
                    "Aspartate Aminotransferase (SGOT/AST)",
                    "Gamma Glutamyl Transferase (GGTP)",
                    "Alkaline Phosphatase",
                    "Acid Phosphatase",
                    "Amylase",
                    "Lipase",
                    "Total Creatine Phosphokinase (CPK)",
                    "CPK-MB Isoenzyme",
                    "CPK-MM Isoenzyme",
                    "Troponin I Qualitative (Serum)",
                    "Troponin T Qualitative (EDTA)",
                    "Lactate Dehydrogenase (LDH)"
                ],
                
                "ELECTROLYTES": [
                    "Sodium",
                    "Potassium", 
                    "Chloride",
                    "Magnesium",
                    "Inorganic Phosphorous",
                    "Total Iron",
                    "Total Iron Binding Capacity (TIBC)",
                    "Calcium",
                    "Ionized Calcium",
                    "Lithium (Serum)",
                    "Ammonia (EDTA)"
                ],
                
                "24 HOUR URINE TEST": [
                    "Creatinine Total",
                    "Creatinine Clearance",
                    "Protein",
                    "Sodium",
                    "Potassium",
                    "Chloride",
                    "Calcium",
                    "Magnesium",
                    "Uric Acid"
                ],
                
                "CHEMISTRY PACKAGES": [
                    "Electrolytes Panel (Sodium, Potassium, Chloride)",
                    "Lipid Profile Complete (Total Cholesterol, Triglycerides, HDL, LDL, VLDL)",
                    "Liver Function Profile (Total Protein, Albumin, Bilirubin, Alkaline Phosphatase, TPAG)",
                    "Kidney Function Profile (Creatinine, BUN, BUA)",
                    "Chemistry 5 (FBS, BUN, Creatinine, BUA, Total Cholesterol)",
                    "Chemistry 6 (FBS, BUN, Creatinine, BUA, Total Cholesterol, Triglycerides)",
                    "Chemistry 8 (Chemistry 5 + Triglycerides, HDL, LDL)",
                    "HIV Test DOH Accredited Screening",
                    "HIV Test DOH Accredited with Titer (ELISA)"
                ],
                
                "HEMATOLOGY": [
                    "Complete Blood Count (CBC)",
                    "CBC with Indices (MCV, MCH, MCHC)",
                    "Platelet Count",
                    "Hemoglobin & Hematocrit",
                    "Reticulocyte Count",
                    "Erythrocyte Sedimentation Rate (ESR)",
                    "ABO Blood Typing",
                    "Peripheral Blood Smear (PBS)",
                    "Malarial Smear",
                    "Lupus Erythematosus (LE) Screening",
                    "Prothrombin Time (Protime)",
                    "Activated Partial Thromboplastin Time (APTT)",
                    "Coombs Test",
                    "Rh Factor"
                ],
                
                "THYROID FUNCTION TEST": [
                    "Triiodothyronine ELISA (T3 ELISA)",
                    "Thyroxine ELISA (T4 ELISA)", 
                    "Thyroid Stimulating Hormone ELISA (TSH ELISA)",
                    "Free T3 ELISA",
                    "Free T4 ELISA",
                    "T3 Electrochemiluminescence Assay (T3 ECLIA)",
                    "T4 Electrochemiluminescence Assay (T4 ECLIA)",
                    "TSH Electrochemiluminescence Assay (TSH ECLIA)",
                    "Free T3 Electrochemiluminescence Assay (FT3 ECLIA)",
                    "Free T4 Electrochemiluminescence Assay (FT4 ECLIA)",
                    "TSH Immunoradiometric Assay (TSH IRMA)",
                    "Parathyroid Hormone",
                    "Free T3 Radioimmunoassay (FT3 RIA)",
                    "Free T4 Radioimmunoassay (FT4 RIA)",
                    "Thyroglobulin"
                ],
                
                "CLINICAL MICROSCOPY": [
                    "Urinalysis",
                    "Urobilinogen",
                    "Ketone/Acetone",
                    "Bile/Nitrates/Bilirubin",
                    "Sugar",
                    "Micro-Albumin Test",
                    "Pregnancy Test (Serum)",
                    "Pregnancy Test (Urine)",
                    "Fecalysis",
                    "Occult Blood",
                    "Body Fluids Analysis (Pleural, Peritoneal, CSF)",
                    "Cell Differential Count",
                    "Sugar in Body Fluids",
                    "Protein in Body Fluids",
                    "Semen Analysis",
                    "Stone Analysis (Urinary)"
                ],
                
                "HEPATITIS SEROLOGY": [
                    "Hepatitis B Surface Antigen Screening (HBsAg Screening)",
                    "Hepatitis B Surface Antigen with Titer",
                    "Anti-Hepatitis B Surface Antibody (Anti-HBs)",
                    "Hepatitis B e Antigen (HBeAg)",
                    "Anti-Hepatitis B e Antibody (Anti-HBe)",
                    "Anti-Hepatitis B Core IgM Antibody",
                    "Anti-Hepatitis B Core IgG Antibody",
                    "Anti-Hepatitis A IgM Antibody",
                    "Anti-Hepatitis A IgG Antibody",
                    "Anti-Hepatitis C Virus Antibody (Anti-HCV)",
                    "Hepatitis Profile (Tests #1-8 except #6)",
                    "Hepatitis A Profile (Tests #7 & #8)",
                    "Hepatitis B Profile (Tests #1-6)",
                    "Hepatitis A & B Profile (Tests #1-8)",
                    "Hepatitis A, B & C Profile (Tests #1-9)"
                ],
                
                "SEROLOGY": [
                    "Venereal Disease Research Laboratory (VDRL/RPR)",
                    "Treponema Pallidum Hemagglutination Rapid Test",
                    "Treponema Pallidum Hemagglutination with Titer",
                    "Widal Test",
                    "Typhidot Test",
                    "Anti-Streptolysin O Latex (Screening & with Titer)",
                    "C-Reactive Protein Latex (Screening & with Titer)",
                    "Rheumatoid Arthritis/Rheumatoid Factor Latex (Screening & with Titer)",
                    "Antinuclear Antibody with Titer (ANA w/ Titer)",
                    "Complement 3 (C3)",
                    "Dengue IgM & IgG Antibodies",
                    "Leptospiral Test (Rapid Test)",
                    "Helicobacter Pylori IgG/IgM ELISA",
                    "Rubella IgM ELISA",
                    "Rubella IgG ELISA",
                    "Cytomegalovirus IgM ELISA",
                    "Cytomegalovirus IgG ELISA",
                    "Toxoplasma IgM ELISA",
                    "Toxoplasma IgG ELISA",
                    "Herpes Simplex Virus 1 & 2 IgM ELISA"
                ],
                
                "HORMONES": [
                    "Follicle Stimulating Hormone (FSH)",
                    "Luteinizing Hormone (LH)",
                    "Prolactin",
                    "Estrogen/Estradiol",
                    "Progesterone",
                    "Testosterone",
                    "Cortisol",
                    "Ferritin"
                ],
                
                "TUMOR MARKERS": [
                    "Alpha-Fetoprotein (AFP)",
                    "Carcinoembryonic Antigen (CEA) - Colon",
                    "Prostate Specific Antigen (PSA) - Prostate",
                    "Beta Human Chorionic Gonadotropin (B-HCG)",
                    "Cancer Antigen 125 (CA-125) - Ovary",
                    "Cancer Antigen 15-3 (CA-15-3) - Breast",
                    "Cancer Antigen 19-9 (CA-19-9) - Pancreas"
                ],
                
                "BACTERIOLOGY": [
                    "All Culture & Sensitivity",
                    "Culture Only",
                    "Gram Stain",
                    "Acid-Fast Bacilli/Direct Sputum Smear Microscopy (AFB/DSSM)",
                    "Potassium Hydroxide Preparation (KOH)",
                    "Mycobacterium Tuberculosis Culture (MTB Culture)",
                    "Cytology Smears FNABs (1-4 smears)",
                    "Cytology Smears FNABs (5-8 smears)",
                    "Cytology Fluids per bottle",
                    "Slide Reviews (1-3 slides)",
                    "Slide Reviews (4-6 slides)",
                    "Estrogen Immunohistochemistry",
                    "Progesterone Immunohistochemistry",
                    "HER2/Neu Immunohistochemistry",
                    "Pap Smear"
                ],
                
                "DRUG TESTING": [
                    "Drug Test 2 Panel",
                    "Drug Test 5 Panel", 
                    "Drug Test 10 Panel"
                ],
                
                "OTHER PROCEDURES": [
                    "Physical Examination (PE)",
                    "Chest X-ray",
                    "Upper & Lower Extremities",
                    "Skull X-ray",
                    "Thoracic Cage",
                    "Cervical X-ray",
                    "Thoraco Lumbar",
                    "Lumbosacral",
                    "KUB/IVP",
                    "Electrocardiogram (ECG)",
                    "Complete Metabolic Panel (CMP) - Adult/Pedia Blood only"
                ]
            };

            for (const [category, procedures] of Object.entries(proceduresData)) {
                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'category-header';
                categoryHeader.dataset.category = category;
                categoryHeader.innerHTML = `${category} <i class="fas fa-chevron-down"></i>`;
                proceduresContainer.appendChild(categoryHeader);

                const categoryOptions = document.createElement('div');
                categoryOptions.className = 'category-options';
                categoryOptions.dataset.category = category;
                
                procedures.forEach(procedure => {
                    const option = document.createElement('div');
                    option.className = 'procedure-option';
                    option.dataset.value = procedure;
                    option.textContent = procedure;
                    categoryOptions.appendChild(option);
                });
                
                proceduresContainer.appendChild(categoryOptions);
            }

            // Add event listeners for category headers
            document.querySelectorAll('.category-header').forEach(header => {
                header.addEventListener('click', () => {
                    const category = header.dataset.category;
                    const options = document.querySelector(`.category-options[data-category="${category}"]`);
                    const icon = header.querySelector('i');
                    if (options.classList.contains('show')) {
                        options.classList.remove('show');
                        icon.classList.remove('fa-chevron-up');
                        icon.classList.add('fa-chevron-down');
                    } else {
                        options.classList.add('show');
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-up');
                    }
                });
            });

            // Add event listeners for procedure options
            document.querySelectorAll('.procedure-option').forEach(option => {
                option.addEventListener('click', () => {
                    // If it's a package option, handle package selection
                    if (option.classList.contains('package-option')) {
                        handlePackageSelection(option.dataset.package);
                    } else {
                        // Regular procedure selection
                        option.classList.toggle('selected');
                    }
                    updateSelectedProceduresDisplay();
                });
            });
        }

        // Handle package selection
        function handlePackageSelection(packageName) {
            // Clear all currently selected procedures first
            document.querySelectorAll('.procedure-option.selected').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Select the package procedures
            const packageProcedures = packageDefinitions[packageName];
            if (packageProcedures && packageProcedures.length > 0) {
                packageProcedures.forEach(procedure => {
                    selectProcedureIfExists(procedure);
                });
            }
            
            // Update package dropdown to match
            document.getElementById('companyPackage').value = packageName;
        }

        function updateSelectedProceduresDisplay() {
            const selectedContainer = document.getElementById('selectedProcedures');
            const selectedOptions = document.querySelectorAll('.procedure-option.selected');
            
            if (selectedOptions.length === 0) {
                selectedContainer.innerHTML = '<div style="color: var(--muted); font-size: 14px; text-align: center; width: 100%;">No procedures selected yet</div>';
                return;
            }
            
            selectedContainer.innerHTML = '';
            selectedOptions.forEach(option => {
                const proc = option.dataset.value;
                const badge = document.createElement('div');
                badge.className = 'procedure-badge';
                badge.innerHTML = `
                    ${proc}
                    <button onclick="deselectProcedure('${proc}')"><i class="fas fa-times"></i></button>
                `;
                selectedContainer.appendChild(badge);
            });
        }

        function deselectProcedure(proc) {
            const option = document.querySelector(`.procedure-option[data-value="${proc}"]`);
            if (option) {
                option.classList.remove('selected');
                updateSelectedProceduresDisplay();
            }
        }

        // Function to auto-select procedures based on package selection from dropdown
        function autoSelectProceduresByPackage() {
            const packageSelect = document.getElementById('companyPackage');
            const selectedPackage = packageSelect.value;
            
            if (selectedPackage && packageDefinitions[selectedPackage]) {
                handlePackageSelection(selectedPackage);
            }
        }

        function selectProcedureIfExists(procedureName) {
            const procedureOption = document.querySelector(`.procedure-option[data-value="${procedureName}"]`);
            if (procedureOption) {
                procedureOption.classList.add('selected');
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Initializing company page...');
            
            document.getElementById('todayDate').textContent = new Date().toLocaleDateString();
            updateTime();
            setInterval(updateTime, 1000);
            
            // Set today's date as default
            document.getElementById('companyDate').value = new Date().toISOString().slice(0,10);
            
            // Update auto-generated number
            updateAutoNumberDisplay();
            
            // Phone number input handling
            const phoneInput = document.getElementById('companyContact');
            phoneInput.addEventListener('input', function(e) {
                validatePhoneInput(e.target);
            });
            
            // Package selection change handler
            document.getElementById('companyPackage').addEventListener('change', autoSelectProceduresByPackage);
            
            initProcedures();
            bindUI();
        });

        function updateTime() {
            const now = new Date();
            let hours = now.getHours();
            let minutes = now.getMinutes();
            let seconds = now.getSeconds();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            
            // Convert to 12-hour format
            hours = hours % 12;
            hours = hours ? hours : 12; // the hour '0' should be '12'
            
            // Add leading zeros
            minutes = minutes < 10 ? '0' + minutes : minutes;
            seconds = seconds < 10 ? '0' + seconds : seconds;
            
            const timeString = `${hours}:${minutes}:${seconds} ${ampm}`;
            document.getElementById('realTime').textContent = `Time: ${timeString}`;
        }

        // UI bindings
        function bindUI() {
            document.getElementById('addCompanyAppointment').addEventListener('click', () => {
                console.log('Add company appointment clicked');
                
                const appointmentNumber = parseInt(document.getElementById('appointmentNumber').value);
                const contact = document.getElementById('companyContact').value.trim();
                const patientName = document.getElementById('companyPatientName').value.trim();
                const company = document.getElementById('companyName').value;
                const package = document.getElementById('companyPackage').value;
                let amount = document.getElementById('companyAmount').value;
                const date = document.getElementById('companyDate').value;
                const procedures = Array.from(document.querySelectorAll('.procedure-option.selected')).map(opt => opt.dataset.value);

                console.log('Form data:', {
                    appointmentNumber, contact, patientName, company, package, amount, date, procedures
                });

                // Validate phone number (11 digits)
                const phoneNumbers = contact.replace(/\s/g, '');
                if (!validatePhoneNumber(contact)) {
                    showToast('Please enter a valid 11-digit phone number in format: +63 9123 456 7890');
                    return;
                }

                // Format contact with +63 prefix (total 14 characters: +63 + 11 digits)
                const formattedContact = '+63' + phoneNumbers;

                // Clean amount value (remove commas)
                amount = amount.replace(/,/g, '');
                const amountNum = parseFloat(amount);

                if (!contact || !patientName || !company || !package || !amount || !date || procedures.length === 0) {
                    showToast('Please fill in all required fields.');
                    return;
                }
                if (isNaN(amountNum) || amountNum <= 0) {
                    showToast('Amount must be a positive number.');
                    return;
                }

                const existingData = getCompanyData();
                
                const newCompany = {
                    id: existingData.length ? Math.max(...existingData.map(w => w.id || 0)) + 1 : 1,
                    appointmentNumber: appointmentNumber,
                    contact: formattedContact,
                    patient_name: patientName,
                    company,
                    package,
                    amount: amountNum,
                    date,
                    procedures,
                    created_at: new Date().toISOString(),
                    created_by: 'Receptionist'
                };

                console.log('New company appointment:', newCompany);

                // Sync with admin storage
                syncWithAdmin(newCompany);
                
                // Show success message
                showSuccessMessage();
                
                // Reset form and update auto number for next appointment
                resetForm();
                updateAutoNumberDisplay();
            });
        }

        function showSuccessMessage() {
            const successMessage = document.getElementById('successMessage');
            successMessage.classList.add('show');
            
            setTimeout(() => {
                successMessage.classList.remove('show');
            }, 3000);
        }

        function resetForm() {
            document.getElementById('companyContact').value = '';
            document.getElementById('companyPatientName').value = '';
            document.getElementById('companyName').value = '';
            document.getElementById('companyPackage').value = '';
            document.getElementById('companyAmount').value = '';
            document.getElementById('companyDate').value = new Date().toISOString().slice(0,10);
            
            // Clear selected procedures
            document.querySelectorAll('.procedure-option').forEach(opt => opt.classList.remove('selected'));
            updateSelectedProceduresDisplay();
            
            // Reset phone hint
            updatePhoneHint('');
        }

        // Toast notification
        function showToast(msg, dur = 3000) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            t.style.opacity = '1';
            setTimeout(() => {
                t.style.opacity = '0';
                t.classList.remove('show');
            }, dur);
        }
    </script>
    </body>
</html>